/**
 * ÊàëÁöÑÈ°µÈù¢ - Profile
 * Áî®Êà∑‰ø°ÊÅØ„ÄÅËÆæÁΩÆ„ÄÅÂàÜ‰∫´Á≠â
 */

import { UserInfoData, StorageConst, StorageUtils, toast } from '@tbs/common';
import { router } from '@kit.ArkUI';
import { promptAction } from '@kit.ArkUI';

@Component
export struct ProfilePage {
  @State userInfo: UserInfoData | null = null

  aboutToAppear(): void {
    this.loadUserInfo();
  }

  /**
   * Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØ
   */
  loadUserInfo(): void {
    const userInfoStr: string = StorageUtils.getStringValueSync(StorageConst.USER_INFO, '');
    if (userInfoStr.length > 0) {
      try {
        this.userInfo = JSON.parse(userInfoStr) as UserInfoData;
      } catch (err) {
        console.error('Ëß£ÊûêÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•:', JSON.stringify(err));
      }
    }
  }

  /**
   * ÁôªÂá∫
   */
  logout(): void {
    promptAction.showDialog({
      title: 'Á°ÆËÆ§ÁôªÂá∫',
      message: 'Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü',
      buttons: [
        {
          text: 'ÂèñÊ∂à',
          color: '#666666'
        },
        {
          text: 'Á°ÆÂÆö',
          color: '#FF0000'
        }
      ]
    }).then((data: promptAction.ShowDialogSuccessResponse) => {
      if (data.index === 1) {
        // Ê∏ÖÈô§ÁôªÂΩï‰ø°ÊÅØ (ÂêéÁ´ØÊó†ÈúÄlogoutÊé•Âè£, ÂÆ¢Êà∑Á´ØÁõ¥Êé•Ê∏ÖÈô§tokenÂç≥ÂèØ)
        StorageUtils.deleteValueSync(StorageConst.TOKEN);
        StorageUtils.deleteValueSync(StorageConst.USER_INFO);

        toast('Â∑≤ÈÄÄÂá∫ÁôªÂΩï');

        // Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µ
        router.replaceUrl({
          url: 'pages/LoginPage'
        }).catch((err: Error) => {
          console.error('Ë∑≥ËΩ¨Â§±Ë¥•:', JSON.stringify(err));
        });
      }
    }).catch(() => {
      console.error('Dialog error');
    });
  }

  build() {
    Column() {
      // ‰∏ªÂÜÖÂÆπÂå∫Âüü
      Scroll() {
        Column({ space: 16 }) {
          // Áî®Êà∑‰ø°ÊÅØÂç°Áâá
          this.UserInfoCard()

          // Ë∫´‰ΩìÊï∞ÊçÆÂç°Áâá
          if (this.userInfo !== null) {
            this.BodyDataCard()
          }

          // ÂäüËÉΩËèúÂçï
          Column({ space: 0 }) {
            this.MenuItem('‰∏™‰∫∫ËµÑÊñô', 'ÁºñËæë‰∏™‰∫∫‰ø°ÊÅØ', () => {
              toast('‰∏™‰∫∫ËµÑÊñôÁºñËæëÂäüËÉΩÂºÄÂèë‰∏≠...');
            })
            this.MenuDivider()
            this.MenuItem('‰∏ªÈ¢òËÆæÁΩÆ', 'ÊµÖËâ≤Ê®°Âºè', () => {
              toast('‰∏ªÈ¢òËÆæÁΩÆÂäüËÉΩÂºÄÂèë‰∏≠...');
            })
            this.MenuDivider()
            this.MenuItem('ËÆ≠ÁªÉÊèêÈÜí', 'Êú™ËÆæÁΩÆ', () => {
              toast('ËÆ≠ÁªÉÊèêÈÜíÂäüËÉΩÂºÄÂèë‰∏≠...');
            })
            this.MenuDivider()
            this.MenuItem('Êï∞ÊçÆÂØºÂá∫', 'CSV/PDF', () => {
              toast('Êï∞ÊçÆÂØºÂá∫ÂäüËÉΩÂºÄÂèë‰∏≠...');
            })
          }
          .width('100%')
          .backgroundColor(Color.White)
          .borderRadius(12)
          .margin({ left: 16, right: 16 })

          // AIÂä©ÊâãÈ¢ÑÁïôÂÖ•Âè£
          Column({ space: 0 }) {
            this.MenuItem('AI ËÆ≠ÁªÉÂä©Êâã', 'Êï¨ËØ∑ÊúüÂæÖ', () => {
              toast('AIËÆ≠ÁªÉÂä©ÊâãÂç≥Â∞Ü‰∏äÁ∫ø');
            }, true)
          }
          .width('100%')
          .backgroundColor(Color.White)
          .borderRadius(12)
          .margin({ left: 16, right: 16 })

          // ÂÖ≥‰∫é
          Column({ space: 0 }) {
            this.MenuItem('ÂÖ≥‰∫é FitEasy', 'v1.0.0', () => {
              toast('FitEasy v1.0.0 - ËÆ©ÂÅ•Ë∫´Êõ¥ÁÆÄÂçï');
            })
          }
          .width('100%')
          .backgroundColor(Color.White)
          .borderRadius(12)
          .margin({ left: 16, right: 16 })

          // ÁôªÂá∫ÊåâÈíÆ
          Button('ÈÄÄÂá∫ÁôªÂΩï')
            .width('90%')
            .height(48)
            .fontSize(16)
            .backgroundColor('#FF3B30')
            .fontColor(Color.White)
            .borderRadius(8)
            .margin({ left: 16, right: 16, top: 8, bottom: 40 })
            .onClick(() => {
              this.logout();
            })
        }
        .width('100%')
        .padding({ top: 16 })
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  UserInfoCard() {
    Row({ space: 16 }) {
      // Â§¥ÂÉè
      Column() {
        Text(this.userInfo?.nickname?.substring(0, 1) ?? 'üë§')
          .fontSize(28)
          .fontColor(Color.White)
      }
      .width(64)
      .height(64)
      .backgroundColor('#007AFF')
      .borderRadius(32)
      .justifyContent(FlexAlign.Center)

      // Áî®Êà∑‰ø°ÊÅØ
      Column({ space: 6 }) {
        Text(this.userInfo?.nickname ?? 'ÂÅ•Ë∫´Áà±Â•ΩËÄÖ')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')

        Text('@' + (this.userInfo?.username ?? 'user'))
          .fontSize(14)
          .fontColor('#666666')

        if (this.userInfo !== null && this.userInfo.fitnessGoal.length > 0) {
          Text('ÁõÆÊ†á: ' + this.userInfo.fitnessGoal)
            .fontSize(12)
            .fontColor('#007AFF')
            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
            .backgroundColor('#E3F2FF')
            .borderRadius(4)
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // ÁºñËæëÊåâÈíÆ
      Text('‚Ä∫')
        .fontSize(24)
        .fontColor('#CCCCCC')
    }
    .width('100%')
    .padding(16)
    .margin({ left: 16, right: 16 })
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(VerticalAlign.Center)
    .onClick(() => {
      toast('ÁºñËæë‰∏™‰∫∫ËµÑÊñôÂäüËÉΩÂºÄÂèë‰∏≠...');
    })
  }

  @Builder
  BodyDataCard() {
    Column({ space: 12 }) {
      Text('Ë∫´‰ΩìÊï∞ÊçÆ')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')

      Row({ space: 12 }) {
        // Ë∫´È´ò
        if (this.userInfo !== null && this.userInfo.height > 0) {
          Column({ space: 4 }) {
            Text(this.userInfo.height.toString())
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#007AFF')
            Text('Ë∫´È´ò(cm)')
              .fontSize(11)
              .fontColor('#666666')
          }
          .layoutWeight(1)
          .padding(12)
          .backgroundColor('#F9F9F9')
          .borderRadius(8)
        }

        // ‰ΩìÈáç
        if (this.userInfo !== null && this.userInfo.weight > 0) {
          Column({ space: 4 }) {
            Text(this.userInfo.weight.toString())
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#34C759')
            Text('‰ΩìÈáç(kg)')
              .fontSize(11)
              .fontColor('#666666')
          }
          .layoutWeight(1)
          .padding(12)
          .backgroundColor('#F9F9F9')
          .borderRadius(8)
        }

        // ÁõÆÊ†á‰ΩìÈáç
        if (this.userInfo !== null && this.userInfo.targetWeight > 0) {
          Column({ space: 4 }) {
            Text(this.userInfo.targetWeight.toString())
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FF9500')
            Text('ÁõÆÊ†á‰ΩìÈáç(kg)')
              .fontSize(11)
              .fontColor('#666666')
          }
          .layoutWeight(1)
          .padding(12)
          .backgroundColor('#F9F9F9')
          .borderRadius(8)
        }
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .margin({ left: 16, right: 16 })
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  MenuItem(title: string, subtitle: string, onClick: () => void, isComingSoon: boolean = false) {
    Row() {
      Column({ space: 4 }) {
        Row({ space: 8 }) {
          Text(title)
            .fontSize(16)
            .fontColor('#333333')

          if (isComingSoon) {
            Text('Âç≥Â∞Ü‰∏äÁ∫ø')
              .fontSize(12)
              .fontColor('#007AFF')
              .padding({ left: 8, right: 8, top: 2, bottom: 2 })
              .backgroundColor('#E3F2FF')
              .borderRadius(4)
          }
        }

        Text(subtitle)
          .fontSize(14)
          .fontColor('#999999')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      Text('‚Ä∫')
        .fontSize(20)
        .fontColor('#CCCCCC')
    }
    .width('100%')
    .height(60)
    .padding({ left: 16, right: 16 })
    .onClick(onClick)
  }

  @Builder
  MenuDivider() {
    Divider()
      .strokeWidth(0.5)
      .color('#E0E0E0')
      .margin({ left: 16, right: 16 })
  }
}
