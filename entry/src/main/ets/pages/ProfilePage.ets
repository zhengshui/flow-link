/**
 * æˆ‘çš„é¡µé¢ - Profile
 * ç”¨æˆ·ä¿¡æ¯ã€è®¾ç½®ã€åˆ†äº«ç­‰
 */

import { UserInfoData, StorageConst, StorageUtils, toast, requestApiCall, ResponseResult, AuthApiService, RouterManager, NavRoutes } from '@tbs/common';
import { promptAction } from '@kit.ArkUI';
import http from '@ohos.net.http';

@Component
export struct ProfilePage {
  @State userInfo: UserInfoData | null = null
  @State isLoading: boolean = false
  @StorageProp('topRectHeight') topRectHeight: number = 0

  aboutToAppear(): void {
    this.loadUserInfo();
  }

  /**
   * åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼ˆä¼˜å…ˆä»APIè·å–ï¼Œå¤±è´¥åˆ™ä»æœ¬åœ°è¯»å–ï¼‰
   */
  async loadUserInfo(): Promise<void> {
    // å…ˆä»æœ¬åœ°è¯»å–
    const userInfoStr: string = StorageUtils.getStringValueSync(StorageConst.USER_INFO, '');
    if (userInfoStr.length > 0) {
      try {
        this.userInfo = JSON.parse(userInfoStr) as UserInfoData;
      } catch (err) {
        console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', JSON.stringify(err));
      }
    }

    // ä»APIè·å–æœ€æ–°ä¿¡æ¯
    await this.fetchUserInfoFromApi();
  }

  /**
   * ä»APIè·å–ç”¨æˆ·ä¿¡æ¯
   */
  async fetchUserInfoFromApi(): Promise<void> {
    if (this.isLoading) {
      return;
    }

    this.isLoading = true;

    try {
      const response: ResponseResult = await AuthApiService.getUserInfo();

      if (response.code === 200 && response.data !== null) {
        // æ›´æ–°æœ¬åœ°å­˜å‚¨
        StorageUtils.saveValueSync(StorageConst.USER_INFO, JSON.stringify(response.data));
        // æ›´æ–°ç•Œé¢
        this.userInfo = response.data as UserInfoData;
      }
    } catch (err) {
      console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', JSON.stringify(err));
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * ç™»å‡º
   */
  logout(): void {
    promptAction.showDialog({
      title: 'ç¡®è®¤ç™»å‡º',
      message: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
      buttons: [
        {
          text: 'å–æ¶ˆ',
          color: '#666666'
        },
        {
          text: 'ç¡®å®š',
          color: '#FF0000'
        }
      ]
    }).then((data: promptAction.ShowDialogSuccessResponse) => {
      if (data.index === 1) {
        // æ¸…é™¤ç™»å½•ä¿¡æ¯ (åç«¯æ— éœ€logoutæ¥å£, å®¢æˆ·ç«¯ç›´æ¥æ¸…é™¤tokenå³å¯)
        StorageUtils.deleteValueSync(StorageConst.TOKEN);
        StorageUtils.deleteValueSync(StorageConst.USER_INFO);

        toast('å·²é€€å‡ºç™»å½•');

        // è®¾ç½®ç™»å½•çŠ¶æ€ä¸º falseï¼Œè§¦å‘ HomePage è·³è½¬åˆ°ç™»å½•é¡µ
        AppStorage.setOrCreate<boolean>('isLoggedIn', false);
      }
    }).catch(() => {
      console.error('Dialog error');
    });
  }

  build() {
    Column() {
      // ä¸»å†…å®¹åŒºåŸŸ
      Scroll() {
        Column({ space: 16 }) {
          // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
          this.UserInfoCard()

          // èº«ä½“æ•°æ®å¡ç‰‡
          if (this.userInfo !== null) {
            this.BodyDataCard()
          }

          // åŠŸèƒ½èœå•
          Column({ space: 0 }) {
            this.MenuItem('ä¸ªäººèµ„æ–™', 'ç¼–è¾‘ä¸ªäººä¿¡æ¯', () => {
              RouterManager.pushPath(NavRoutes.PROFILE_EDIT);
            })
            this.MenuDivider()
            this.MenuItem('ä¸»é¢˜è®¾ç½®', this.getThemeDisplay(), () => {
              RouterManager.pushPath(NavRoutes.THEME_SETTINGS);
            })
            this.MenuDivider()
            this.MenuItem('è®­ç»ƒæé†’', this.getReminderDisplay(), () => {
              RouterManager.pushPath(NavRoutes.REMINDER_SETTINGS);
            })
          }
          .width('100%')
          .backgroundColor(Color.White)
          .borderRadius(12)
          .margin({ left: 16, right: 16 })

          // å…³äº
          Column({ space: 0 }) {
            this.MenuItem('å…³äº FitEasy', 'v1.0.0', () => {
              RouterManager.pushPath(NavRoutes.ABOUT);
            })
          }
          .width('100%')
          .backgroundColor(Color.White)
          .borderRadius(12)
          .margin({ left: 16, right: 16 })

          // ç™»å‡ºæŒ‰é’®
          Button('é€€å‡ºç™»å½•')
            .width('90%')
            .height(48)
            .fontSize(16)
            .backgroundColor('#FF3B30')
            .fontColor(Color.White)
            .borderRadius(8)
            .margin({ left: 16, right: 16, top: 8, bottom: 40 })
            .onClick(() => {
              this.logout();
            })
        }
        .width('100%')
        .padding({ top: 16 })
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
    // é¡¶éƒ¨çŠ¶æ€æ é¿è®©
    .padding({ top: this.getUIContext().px2vp(this.topRectHeight) })
  }

  @Builder
  UserInfoCard() {
    Row({ space: 16 }) {
      // å¤´åƒ
      Column() {
        Text(this.userInfo?.nickname?.substring(0, 1) ?? 'ğŸ‘¤')
          .fontSize(28)
          .fontColor(Color.White)
      }
      .width(64)
      .height(64)
      .backgroundColor('#007AFF')
      .borderRadius(32)
      .justifyContent(FlexAlign.Center)

      // ç”¨æˆ·ä¿¡æ¯
      Column({ space: 6 }) {
        Text(this.userInfo?.nickname ?? 'å¥èº«çˆ±å¥½è€…')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')

        Text('@' + (this.userInfo?.username ?? 'user'))
          .fontSize(14)
          .fontColor('#666666')

        if (this.userInfo !== null && this.userInfo.fitnessGoal.length > 0) {
          Text('ç›®æ ‡: ' + this.userInfo.fitnessGoal)
            .fontSize(12)
            .fontColor('#007AFF')
            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
            .backgroundColor('#E3F2FF')
            .borderRadius(4)
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // ç¼–è¾‘æŒ‰é’®
      Text('â€º')
        .fontSize(24)
        .fontColor('#CCCCCC')
    }
    .width('100%')
    .padding(16)
    .margin({ left: 16, right: 16 })
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(VerticalAlign.Center)
    .onClick(() => {
      RouterManager.pushPath(NavRoutes.PROFILE_EDIT);
    })
  }

  /**
   * è·å–ä¸»é¢˜æ˜¾ç¤ºæ–‡æœ¬
   */
  getThemeDisplay(): string {
    const theme: string = StorageUtils.getStringValueSync('app_theme', 'light');
    if (theme === 'dark') {
      return 'æ·±è‰²æ¨¡å¼';
    } else if (theme === 'auto') {
      return 'è·Ÿéšç³»ç»Ÿ';
    }
    return 'æµ…è‰²æ¨¡å¼';
  }

  /**
   * è·å–æé†’æ˜¾ç¤ºæ–‡æœ¬
   */
  getReminderDisplay(): string {
    const enabledStr: string = StorageUtils.getStringValueSync('reminder_enabled', 'false');
    const enabled: boolean = enabledStr === 'true';
    if (enabled) {
      const time: string = StorageUtils.getStringValueSync('reminder_time', '18:00');
      return 'å·²è®¾ç½® ' + time;
    }
    return 'æœªè®¾ç½®';
  }

  @Builder
  BodyDataCard() {
    Column({ space: 12 }) {
      Text('èº«ä½“æ•°æ®')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')

      Row({ space: 12 }) {
        // èº«é«˜
        if (this.userInfo !== null && this.userInfo.height > 0) {
          Column({ space: 4 }) {
            Text(this.userInfo.height.toString())
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#007AFF')
            Text('èº«é«˜(cm)')
              .fontSize(11)
              .fontColor('#666666')
          }
          .layoutWeight(1)
          .padding(12)
          .backgroundColor('#F9F9F9')
          .borderRadius(8)
        }

        // ä½“é‡
        if (this.userInfo !== null && this.userInfo.weight > 0) {
          Column({ space: 4 }) {
            Text(this.userInfo.weight.toString())
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#34C759')
            Text('ä½“é‡(kg)')
              .fontSize(11)
              .fontColor('#666666')
          }
          .layoutWeight(1)
          .padding(12)
          .backgroundColor('#F9F9F9')
          .borderRadius(8)
        }

        // ç›®æ ‡ä½“é‡
        if (this.userInfo !== null && this.userInfo.targetWeight > 0) {
          Column({ space: 4 }) {
            Text(this.userInfo.targetWeight.toString())
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FF9500')
            Text('ç›®æ ‡ä½“é‡(kg)')
              .fontSize(11)
              .fontColor('#666666')
          }
          .layoutWeight(1)
          .padding(12)
          .backgroundColor('#F9F9F9')
          .borderRadius(8)
        }
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .margin({ left: 16, right: 16 })
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  MenuItem(title: string, subtitle: string, onClick: () => void, isComingSoon: boolean = false) {
    Row() {
      Column({ space: 4 }) {
        Row({ space: 8 }) {
          Text(title)
            .fontSize(16)
            .fontColor('#333333')

          if (isComingSoon) {
            Text('å³å°†ä¸Šçº¿')
              .fontSize(12)
              .fontColor('#007AFF')
              .padding({ left: 8, right: 8, top: 2, bottom: 2 })
              .backgroundColor('#E3F2FF')
              .borderRadius(4)
          }
        }

        Text(subtitle)
          .fontSize(14)
          .fontColor('#999999')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      Text('â€º')
        .fontSize(20)
        .fontColor('#CCCCCC')
    }
    .width('100%')
    .height(60)
    .padding({ left: 16, right: 16 })
    .onClick(onClick)
  }

  @Builder
  MenuDivider() {
    Divider()
      .strokeWidth(0.5)
      .color('#E0E0E0')
      .margin({ left: 16, right: 16 })
  }
}
