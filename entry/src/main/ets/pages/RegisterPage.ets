/**
 * æ³¨å†Œé¡µé¢ - Register
 * æ–°ç”¨æˆ·æ³¨å†Œ
 */

import { MockAuthService, toast } from '@tbs/common';
import { router } from '@kit.ArkUI';
import { ResponseResult } from '@tbs/common/src/main/ets/http/response';

@Entry
@Component
struct RegisterPage {
  @State username: string = ''
  @State password: string = ''
  @State confirmPassword: string = ''
  @State nickname: string = ''
  @State email: string = ''
  @State isLoading: boolean = false

  /**
   * æ‰§è¡Œæ³¨å†Œ
   */
  async register(): Promise<void> {
    if (!this.username) {
      toast('è¯·è¾“å…¥ç”¨æˆ·å');
      return;
    }
    if (this.username.length < 4) {
      toast('ç”¨æˆ·åè‡³å°‘4ä¸ªå­—ç¬¦');
      return;
    }
    if (!this.password) {
      toast('è¯·è¾“å…¥å¯†ç ');
      return;
    }
    if (this.password.length < 6) {
      toast('å¯†ç è‡³å°‘6ä¸ªå­—ç¬¦');
      return;
    }
    if (!this.confirmPassword) {
      toast('è¯·ç¡®è®¤å¯†ç ');
      return;
    }
    if (this.password !== this.confirmPassword) {
      toast('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
      return;
    }
    if (!this.nickname) {
      toast('è¯·è¾“å…¥æ˜µç§°');
      return;
    }

    this.isLoading = true;

    try {
      const res: ResponseResult = await MockAuthService.register(
        this.username,
        this.password,
        this.nickname,
        this.email
      );

      if (res.code === 0) {
        toast('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
        // è¿”å›ç™»å½•é¡µ
        router.back();
      } else {
        toast(res.message);
      }
    } catch (err) {
      console.error('æ³¨å†Œå¤±è´¥:', JSON.stringify(err));
      toast('æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * è¿”å›ç™»å½•é¡µ
   */
  goBack(): void {
    router.back();
  }

  build() {
    Column({ space: 0 }) {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('<')
          .fontSize(24)
          .fontColor('#007AFF')
          .onClick(() => {
            this.goBack();
          })

        Text('æ³¨å†Œ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ left: 12 })
          .layoutWeight(1)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor(Color.White)
      .justifyContent(FlexAlign.Start)
      .alignItems(VerticalAlign.Center)

      Scroll() {
        Column({ space: 20 }) {
          // Logo
          Column() {
            Text('ğŸ’ª')
              .fontSize(60)
          }
          .margin({ top: 40 })

          // è¡¨å•åŒºåŸŸ
          Column({ space: 16 }) {
            // ç”¨æˆ·å
            Column({ space: 8 }) {
              Text('ç”¨æˆ·å')
                .fontSize(14)
                .fontColor('#333333')
                .width('100%')

              TextInput({ placeholder: 'è¯·è¾“å…¥ç”¨æˆ·åï¼ˆè‡³å°‘4ä¸ªå­—ç¬¦ï¼‰' })
                .width('100%')
                .height(48)
                .backgroundColor(Color.White)
                .borderRadius(8)
                .onChange((value: string) => {
                  this.username = value;
                })
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)

            // å¯†ç 
            Column({ space: 8 }) {
              Text('å¯†ç ')
                .fontSize(14)
                .fontColor('#333333')
                .width('100%')

              TextInput({ placeholder: 'è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä¸ªå­—ç¬¦ï¼‰' })
                .width('100%')
                .height(48)
                .type(InputType.Password)
                .backgroundColor(Color.White)
                .borderRadius(8)
                .onChange((value: string) => {
                  this.password = value;
                })
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)

            // ç¡®è®¤å¯†ç 
            Column({ space: 8 }) {
              Text('ç¡®è®¤å¯†ç ')
                .fontSize(14)
                .fontColor('#333333')
                .width('100%')

              TextInput({ placeholder: 'è¯·å†æ¬¡è¾“å…¥å¯†ç ' })
                .width('100%')
                .height(48)
                .type(InputType.Password)
                .backgroundColor(Color.White)
                .borderRadius(8)
                .onChange((value: string) => {
                  this.confirmPassword = value;
                })
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)

            // æ˜µç§°
            Column({ space: 8 }) {
              Text('æ˜µç§°')
                .fontSize(14)
                .fontColor('#333333')
                .width('100%')

              TextInput({ placeholder: 'è¯·è¾“å…¥æ˜µç§°' })
                .width('100%')
                .height(48)
                .backgroundColor(Color.White)
                .borderRadius(8)
                .onChange((value: string) => {
                  this.nickname = value;
                })
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)

            // é‚®ç®±ï¼ˆå¯é€‰ï¼‰
            Column({ space: 8 }) {
              Text('é‚®ç®±ï¼ˆå¯é€‰ï¼‰')
                .fontSize(14)
                .fontColor('#333333')
                .width('100%')

              TextInput({ placeholder: 'è¯·è¾“å…¥é‚®ç®±' })
                .width('100%')
                .height(48)
                .backgroundColor(Color.White)
                .borderRadius(8)
                .onChange((value: string) => {
                  this.email = value;
                })
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)

            // æ³¨å†ŒæŒ‰é’®
            Button(this.isLoading ? 'æ³¨å†Œä¸­...' : 'ç«‹å³æ³¨å†Œ')
              .width('100%')
              .height(48)
              .fontSize(16)
              .backgroundColor('#007AFF')
              .borderRadius(8)
              .margin({ top: 20 })
              .opacity((this.username.length > 0 && this.password.length > 0 &&
                this.confirmPassword.length > 0 && this.nickname.length > 0 && !this.isLoading) ? 1 : 0.5)
              .enabled(this.username.length > 0 && this.password.length > 0 &&
                this.confirmPassword.length > 0 && this.nickname.length > 0 && !this.isLoading)
              .onClick(() => {
                this.register();
              })
          }
          .width('90%')
          .padding(20)
          .margin({ top: 20 })

          // åº•éƒ¨æç¤º
          Row({ space: 4 }) {
            Text('å·²æœ‰è´¦å·ï¼Ÿ')
              .fontSize(14)
              .fontColor('#666666')

            Text('ç«‹å³ç™»å½•')
              .fontSize(14)
              .fontColor('#007AFF')
              .fontWeight(FontWeight.Medium)
              .onClick(() => {
                this.goBack();
              })
          }
          .margin({ bottom: 40 })
        }
        .width('100%')
        .alignItems(HorizontalAlign.Center)
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}
