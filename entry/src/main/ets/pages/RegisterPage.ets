/**
 * æ³¨å†Œé¡µé¢ - Register
 * æ–°ç”¨æˆ·æ³¨å†Œ
 * ä½¿ç”¨ NavDestination ä½œä¸º Navigation å­é¡µé¢
 */

import { AuthApiService, toast } from '@tbs/common';
import { ResponseResult } from '@tbs/common/src/main/ets/http/response';

/**
 * ç³»ç»Ÿè·¯ç”±è¡¨æ„å»ºå‡½æ•°
 */
@Builder
export function RegisterPageBuilder(): void {
  RegisterPage()
}

@Component
export struct RegisterPage {
  @State username: string = ''
  @State password: string = ''
  @State confirmPassword: string = ''
  @State nickname: string = ''
  @State email: string = ''
  @State isLoading: boolean = false
  @StorageProp('topRectHeight') topRectHeight: number = 0
  private pathStack: NavPathStack = new NavPathStack()

  /**
   * æ‰§è¡Œæ³¨å†Œ
   */
  async register(): Promise<void> {
    if (!this.username) {
      toast('è¯·è¾“å…¥ç”¨æˆ·å');
      return;
    }
    if (this.username.length < 4) {
      toast('ç”¨æˆ·åè‡³å°‘4ä¸ªå­—ç¬¦');
      return;
    }
    if (!this.password) {
      toast('è¯·è¾“å…¥å¯†ç ');
      return;
    }
    if (this.password.length < 6) {
      toast('å¯†ç è‡³å°‘6ä¸ªå­—ç¬¦');
      return;
    }
    if (!this.confirmPassword) {
      toast('è¯·ç¡®è®¤å¯†ç ');
      return;
    }
    if (this.password !== this.confirmPassword) {
      toast('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
      return;
    }
    if (!this.nickname) {
      toast('è¯·è¾“å…¥æ˜µç§°');
      return;
    }

    this.isLoading = true;

    try {
      const res: ResponseResult = await AuthApiService.register(
        this.username,
        this.password,
        this.nickname,
        this.email
      );

      if (res.code === 0) {
        toast('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
        // è¿”å›ç™»å½•é¡µ
        this.pathStack.pop();
      } else {
        toast(res.message ?? 'æ³¨å†Œå¤±è´¥');
      }
    } catch (err) {
      console.error('æ³¨å†Œå¤±è´¥:', JSON.stringify(err));
      toast('æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      this.isLoading = false;
    }
  }

  build() {
    NavDestination() {
      Column() {
        // è‡ªå®šä¹‰æ ‡é¢˜æ 
        Row() {
          SymbolGlyph($r('sys.symbol.chevron_left'))
            .fontSize(24)
            .fontColor([$r('app.color.text_primary')])
            .onClick(() => {
              this.pathStack.pop();
            })

          Text('æ³¨å†Œ')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.text_primary'))
            .layoutWeight(1)
            .textAlign(TextAlign.Center)

          // å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
          Column().width(24)
        }
        .width('100%')
        .height(70)
        .padding({ left: 16, right: 16, top: this.getUIContext().px2vp(this.topRectHeight) })
        .backgroundColor($r('app.color.card_background'))

        Scroll() {
          Column({ space: 20 }) {
            // Logo
            Column() {
              Text('ğŸ’ª')
                .fontSize(60)
            }
            .margin({ top: 20 })

          // è¡¨å•åŒºåŸŸ
          Column({ space: 14 }) {
            // ç”¨æˆ·å
            Column({ space: 6 }) {
              Text('ç”¨æˆ·å')
                .fontSize(13)
                .fontColor($r('app.color.text_secondary'))
                .width('100%')

              TextInput({ placeholder: 'è¯·è¾“å…¥ç”¨æˆ·åï¼ˆè‡³å°‘4ä¸ªå­—ç¬¦ï¼‰' })
                .width('100%')
                .height(46)
                .fontSize(15)
                .backgroundColor($r('app.color.card_background'))
                .borderRadius(8)
                .onChange((value: string) => {
                  this.username = value;
                })
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)

            // å¯†ç 
            Column({ space: 6 }) {
              Text('å¯†ç ')
                .fontSize(13)
                .fontColor($r('app.color.text_secondary'))
                .width('100%')

              TextInput({ placeholder: 'è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä¸ªå­—ç¬¦ï¼‰' })
                .width('100%')
                .height(46)
                .fontSize(15)
                .type(InputType.Password)
                .backgroundColor($r('app.color.card_background'))
                .borderRadius(8)
                .onChange((value: string) => {
                  this.password = value;
                })
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)

            // ç¡®è®¤å¯†ç 
            Column({ space: 6 }) {
              Text('ç¡®è®¤å¯†ç ')
                .fontSize(13)
                .fontColor($r('app.color.text_secondary'))
                .width('100%')

              TextInput({ placeholder: 'è¯·å†æ¬¡è¾“å…¥å¯†ç ' })
                .width('100%')
                .height(46)
                .fontSize(15)
                .type(InputType.Password)
                .backgroundColor($r('app.color.card_background'))
                .borderRadius(8)
                .onChange((value: string) => {
                  this.confirmPassword = value;
                })
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)

            // æ˜µç§°
            Column({ space: 6 }) {
              Text('æ˜µç§°')
                .fontSize(13)
                .fontColor($r('app.color.text_secondary'))
                .width('100%')

              TextInput({ placeholder: 'è¯·è¾“å…¥æ˜µç§°' })
                .width('100%')
                .height(46)
                .fontSize(15)
                .backgroundColor($r('app.color.card_background'))
                .borderRadius(8)
                .onChange((value: string) => {
                  this.nickname = value;
                })
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)

            // é‚®ç®±ï¼ˆå¯é€‰ï¼‰
            Column({ space: 6 }) {
              Text('é‚®ç®±ï¼ˆå¯é€‰ï¼‰')
                .fontSize(13)
                .fontColor($r('app.color.text_secondary'))
                .width('100%')

              TextInput({ placeholder: 'è¯·è¾“å…¥é‚®ç®±' })
                .width('100%')
                .height(46)
                .fontSize(15)
                .backgroundColor($r('app.color.card_background'))
                .borderRadius(8)
                .onChange((value: string) => {
                  this.email = value;
                })
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)

            // æ³¨å†ŒæŒ‰é’®
            Button(this.isLoading ? 'æ³¨å†Œä¸­...' : 'ç«‹å³æ³¨å†Œ')
              .width('100%')
              .height(46)
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .backgroundColor($r('app.color.brand_primary'))
              .borderRadius(10)
              .margin({ top: 16 })
              .opacity((this.username.length > 0 && this.password.length > 0 &&
                this.confirmPassword.length > 0 && this.nickname.length > 0 && !this.isLoading) ? 1 : 0.5)
              .enabled(this.username.length > 0 && this.password.length > 0 &&
                this.confirmPassword.length > 0 && this.nickname.length > 0 && !this.isLoading)
              .onClick(() => {
                this.register();
              })
          }
          .width('90%')
          .padding(16)
          .margin({ top: 16 })

          // åº•éƒ¨æç¤º
          Row({ space: 4 }) {
            Text('å·²æœ‰è´¦å·ï¼Ÿ')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))

            Text('ç«‹å³ç™»å½•')
              .fontSize(14)
              .fontColor($r('app.color.brand_primary'))
              .fontWeight(FontWeight.Medium)
              .onClick(() => {
                this.pathStack.pop();
              })
          }
          .margin({ bottom: 40 })
        }
        .width('100%')
        .alignItems(HorizontalAlign.Center)
      }
      .layoutWeight(1)
      }
      .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.page_background'))
    }
    .hideTitleBar(true)
    .onReady((context: NavDestinationContext) => {
      this.pathStack = context.pathStack
    })
  }
}
