/**
 * ä¸»é¢˜è®¾ç½®é¡µé¢
 * è®¾ç½®åº”ç”¨çš„ä¸»é¢˜ï¼ˆæµ…è‰²/æ·±è‰²/è·Ÿéšç³»ç»Ÿï¼‰
 * ä½¿ç”¨ NavDestination ä½œä¸º Navigation å­é¡µé¢
 */

import { StorageUtils, toast, GlobalContext } from '@tbs/common';
import { ConfigurationConstant, common } from '@kit.AbilityKit';

/**
 * ç³»ç»Ÿè·¯ç”±è¡¨æ„å»ºå‡½æ•°
 */
@Builder
export function ThemeSettingsPageBuilder(): void {
  ThemeSettingsPage()
}

@Component
export struct ThemeSettingsPage {
  @State currentTheme: string = 'auto'
  @StorageProp('topRectHeight') topRectHeight: number = 0
  @StorageProp('currentColorMode') @Watch('onColorModeChange') currentColorMode: number = ConfigurationConstant.ColorMode.COLOR_MODE_LIGHT
  private pathStack: NavPathStack = new NavPathStack()
  private themeOptions: ThemeOption[] = [
    { name: 'æµ…è‰²æ¨¡å¼', value: 'light', description: 'æ˜äº®æ¸…çˆ½ï¼Œé€‚åˆç™½å¤©ä½¿ç”¨', icon: 'â˜€ï¸' },
    { name: 'æ·±è‰²æ¨¡å¼', value: 'dark', description: 'èˆ’é€‚æŠ¤çœ¼ï¼Œé€‚åˆå¤œé—´ä½¿ç”¨', icon: 'ğŸŒ™' },
  ]

  aboutToAppear(): void {
    this.loadTheme();
  }

  /**
   * é¢œè‰²æ¨¡å¼å˜åŒ–å›è°ƒ
   */
  onColorModeChange(): void {
    // è§¦å‘ UI åˆ·æ–°
  }

  /**
   * åŠ è½½ä¸»é¢˜è®¾ç½®
   */
  loadTheme(): void {
    this.currentTheme = StorageUtils.getStringValueSync('app_theme', 'auto');
  }

  /**
   * ä¿å­˜ä¸»é¢˜è®¾ç½®
   */
  saveTheme(theme: string): void {
    this.currentTheme = theme;
    StorageUtils.saveValueSync('app_theme', theme);

    // åº”ç”¨ä¸»é¢˜åˆ‡æ¢
    this.applyTheme(theme);

    toast('ä¸»é¢˜å·²åˆ‡æ¢ä¸º' + this.getThemeName(theme));
  }

  /**
   * åº”ç”¨ä¸»é¢˜åˆ‡æ¢
   */
  applyTheme(theme: string): void {
    try {
      const context: common.UIAbilityContext = GlobalContext.getContext().getObject('context') as common.UIAbilityContext;
      if (context !== undefined) {
        if (theme === 'light') {
          context.getApplicationContext().setColorMode(ConfigurationConstant.ColorMode.COLOR_MODE_LIGHT);
        } else if (theme === 'dark') {
          context.getApplicationContext().setColorMode(ConfigurationConstant.ColorMode.COLOR_MODE_DARK);
        } else {
          // auto - è·Ÿéšç³»ç»Ÿ
          context.getApplicationContext().setColorMode(ConfigurationConstant.ColorMode.COLOR_MODE_NOT_SET);
        }
      }
    } catch (err) {
      console.error('åº”ç”¨ä¸»é¢˜åˆ‡æ¢å¤±è´¥:', JSON.stringify(err));
    }
  }

  /**
   * è·å–ä¸»é¢˜åç§°
   */
  getThemeName(theme: string): string {
    for (let i: number = 0; i < this.themeOptions.length; i++) {
      if (this.themeOptions[i].value === theme) {
        return this.themeOptions[i].name;
      }
    }
    return 'æµ…è‰²æ¨¡å¼';
  }

  /**
   * åˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºæ·±è‰²æ¨¡å¼
   */
  isDarkMode(): boolean {
    return this.currentColorMode === ConfigurationConstant.ColorMode.COLOR_MODE_DARK;
  }

  build() {
    NavDestination() {
      Column() {
        // è‡ªå®šä¹‰æ ‡é¢˜æ 
        Row() {
          SymbolGlyph($r('sys.symbol.chevron_left'))
            .fontSize(24)
            .fontColor([$r('app.color.text_primary')])
            .onClick(() => {
              this.pathStack.pop();
            })

          Text('ä¸»é¢˜è®¾ç½®')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.text_primary'))
            .layoutWeight(1)
            .textAlign(TextAlign.Center)

          // å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
          Column().width(24)
        }
        .width('100%')
        .height(70)
        .padding({ left: 16, right: 16, top: this.getUIContext().px2vp(this.topRectHeight) })
        .backgroundColor($r('app.color.card_background'))

        // ä¸»é¢˜é¢„è§ˆå¡ç‰‡
        Column({ space: 16 }) {
          Text('å½“å‰é¢„è§ˆ')
            .fontSize(14)
            .fontColor($r('app.color.text_hint'))

          Row({ space: 16 }) {
            // æµ…è‰²é¢„è§ˆ
            Column({ space: 8 }) {
              Column()
                .width(80)
                .height(60)
                .backgroundColor('#F7F8FA')
                .borderRadius(8)
                .border({ width: this.currentTheme === 'light' || (this.currentTheme === 'auto' && !this.isDarkMode()) ? 2 : 1,
                  color: this.currentTheme === 'light' || (this.currentTheme === 'auto' && !this.isDarkMode()) ? $r('app.color.brand_primary') : $r('app.color.outline') })
              Text('æµ…è‰²')
                .fontSize(12)
                .fontColor($r('app.color.text_secondary'))
            }

            // æ·±è‰²é¢„è§ˆ
            Column({ space: 8 }) {
              Column()
                .width(80)
                .height(60)
                .backgroundColor('#1A1A1A')
                .borderRadius(8)
                .border({ width: this.currentTheme === 'dark' || (this.currentTheme === 'auto' && this.isDarkMode()) ? 2 : 1,
                  color: this.currentTheme === 'dark' || (this.currentTheme === 'auto' && this.isDarkMode()) ? $r('app.color.brand_primary') : $r('app.color.outline') })
              Text('æ·±è‰²')
                .fontSize(12)
                .fontColor($r('app.color.text_secondary'))
            }
          }
        }
        .width('100%')
        .padding(20)
        .margin({ left: 16, right: 16, top: 16 })
        .backgroundColor($r('app.color.card_background'))
        .borderRadius(12)
        .alignItems(HorizontalAlign.Center)

        // ä¸»é¢˜é€‰é¡¹åˆ—è¡¨
        Column({ space: 0 }) {
          ForEach(this.themeOptions, (option: ThemeOption, index: number) => {
            this.ThemeOptionItem(option, index === this.themeOptions.length - 1)
          })
        }
        .width('100%')
        .backgroundColor($r('app.color.card_background'))
        .borderRadius(12)
        .margin({ left: 16, right: 16, top: 16 })

        // æç¤ºä¿¡æ¯
        Text('åˆ‡æ¢ä¸»é¢˜åä¼šç«‹å³ç”Ÿæ•ˆï¼Œæ‰€æœ‰é¡µé¢çš„é…è‰²å°†åŒæ­¥æ›´æ–°ã€‚')
          .fontSize(12)
          .fontColor($r('app.color.text_hint'))
          .width('100%')
          .padding({ left: 24, right: 24, top: 16 })
          .textAlign(TextAlign.Center)

        Blank()
      }
      .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.page_background'))
    }
    .hideTitleBar(true)
    .onReady((context: NavDestinationContext) => {
      this.pathStack = context.pathStack
    })
  }

  @Builder
  ThemeOptionItem(option: ThemeOption, isLast: boolean) {
    Column({ space: 0 }) {
      Row() {
        // å›¾æ ‡
        Text(option.icon)
          .fontSize(24)
          .width(40)

        // æ–‡å­—å†…å®¹
        Column({ space: 4 }) {
          Text(option.name)
            .fontSize(16)
            .fontColor($r('app.color.text_primary'))
            .fontWeight(FontWeight.Medium)

          Text(option.description)
            .fontSize(13)
            .fontColor($r('app.color.text_hint'))
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        // é€‰ä¸­æ ‡è®°
        if (this.currentTheme === option.value) {
          Text('âœ“')
            .fontSize(20)
            .fontColor($r('app.color.brand_primary'))
            .fontWeight(FontWeight.Bold)
        }
      }
      .width('100%')
      .height(72)
      .padding({ left: 16, right: 16 })
      .onClick((): void => {
        this.saveTheme(option.value);
      })

      if (!isLast) {
        Divider()
          .strokeWidth(0.5)
          .color($r('app.color.outline'))
          .margin({ left: 56, right: 16 })
      }
    }
  }
}

/**
 * ä¸»é¢˜é€‰é¡¹ç±»å‹
 */
class ThemeOption {
  name: string = ''
  value: string = ''
  description: string = ''
  icon: string = ''
}
