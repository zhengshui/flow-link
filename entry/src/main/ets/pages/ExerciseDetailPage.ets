/**
 * Âä®‰ΩúËØ¶ÊÉÖÈ°µÈù¢ - Exercise Detail
 * ÊòæÁ§∫Âä®‰ΩúÁöÑËØ¶ÁªÜ‰ø°ÊÅØ„ÄÅËßÜÈ¢ëËÆ≤Ëß£ÂíåÂä®‰ΩúÊ≠•È™§
 * ‰ΩøÁî® NavDestination ‰Ωú‰∏∫ Navigation Â≠êÈ°µÈù¢
 */

import { ActionModel, ActionDataService, NavRouteParams } from '@tbs/common';

/**
 * Á≥ªÁªüË∑ØÁî±Ë°®ÊûÑÂª∫ÂáΩÊï∞
 */
@Builder
export function ExerciseDetailPageBuilder(): void {
  ExerciseDetailPage()
}

@Component
export struct ExerciseDetailPage {
  @State action: ActionModel | null = null
  @State actionId: string = ''
  @StorageProp('topRectHeight') topRectHeight: number = 0
  @StorageProp('bottomRectHeight') bottomRectHeight: number = 0
  private pathStack: NavPathStack = new NavPathStack()

  /**
   * Âä†ËΩΩÂä®‰ΩúÊï∞ÊçÆ
   */
  loadData(): void {
    this.action = ActionDataService.getActionById(this.actionId);
  }

  build() {
    NavDestination() {
      Column() {
        // Ëá™ÂÆö‰πâÊ†áÈ¢òÊ†è
        Row() {
          SymbolGlyph($r('sys.symbol.chevron_left'))
            .fontSize(24)
            .fontColor([$r('app.color.text_primary')])
            .onClick(() => {
              this.pathStack.pop();
            })

          Text(this.action?.name ?? 'Âä®‰ΩúËØ¶ÊÉÖ')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.text_primary'))
            .layoutWeight(1)
            .textAlign(TextAlign.Center)

          // Âç†‰ΩçÔºå‰øùÊåÅÊ†áÈ¢òÂ±Ö‰∏≠
          Column().width(24)
        }
        .width('100%')
        .height(70)
        .padding({ left: 16, right: 16, top: this.getUIContext().px2vp(this.topRectHeight) })
        .backgroundColor($r('app.color.card_background'))

        if (this.action !== null) {
          // ‰∏ªÂÜÖÂÆπÂå∫Âüü
          Scroll() {
            Column({ space: 16 }) {
              // ËßÜÈ¢ëÂå∫Âüü
              this.VideoSection()

              // Âü∫Êú¨‰ø°ÊÅØ
              this.BasicInfoSection()

              // Âä®‰ΩúÊèèËø∞
              this.DescriptionSection()

              // Âä®‰ΩúÊ≠•È™§
              this.StepsSection()

              // Ê≥®ÊÑè‰∫ãÈ°π
              if (this.action.tips.length > 0) {
                this.TipsSection()
              }

              // Â∫ïÈÉ®ÂÆâÂÖ®Âå∫ÂüüÈÅøËÆ©
              Column()
                .height(20 + this.getUIContext().px2vp(this.bottomRectHeight))
            }
            .width('100%')
            .padding(16)
          }
          .width('100%')
          .height('100%')
          .align(Alignment.Top)
        } else {
          // Êó†Êï∞ÊçÆ
          Column() {
            Text('Âä®‰Ωú‰∏çÂ≠òÂú®')
              .fontSize(16)
              .fontColor($r('app.color.text_hint'))
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.page_background'))
    }
    .hideTitleBar(true)
    .onReady((context: NavDestinationContext) => {
      this.pathStack = context.pathStack
      // Ëé∑ÂèñË∑ØÁî±ÂèÇÊï∞
      const params: NavRouteParams | undefined = context.pathInfo.param as NavRouteParams | undefined
      if (params !== undefined && params.actionId !== undefined) {
        this.actionId = params.actionId
        this.loadData()
      }
    })
  }

  @Builder
  VideoSection() {
    Column({ space: 12 }) {
      // Âä®‰ΩúÊºîÁ§∫GIFÂå∫Âüü
      Column() {
        if (this.action !== null && this.action.gifUrl.length > 0) {
          // ÊòæÁ§∫GIFÂä®Áîª
          Image($rawfile(`exercises/${this.action.gifUrl}`))
            .width('100%')
            .height(220)
            .objectFit(ImageFit.Contain)
            .borderRadius(12)
        } else {
          // Êó†GIFËµÑÊ∫êÊó∂ÊòæÁ§∫Âç†‰ΩçÁ¨¶
          Column() {
            Text('üé¨')
              .fontSize(48)

            Text('ÊöÇÊó†Âä®‰ΩúÊºîÁ§∫')
              .fontSize(14)
              .fontColor($r('app.color.text_hint'))
              .margin({ top: 8 })
          }
          .width('100%')
          .height(220)
          .backgroundColor($r('app.color.outline'))
          .borderRadius(12)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        }
      }
      .width('100%')

      Text(this.action?.name ?? '')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .textAlign(TextAlign.Center)
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(12)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  BasicInfoSection() {
    Column({ space: 12 }) {
      Text('Âü∫Êú¨‰ø°ÊÅØ')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))

      // ‰ø°ÊÅØÂç°Áâá
      Row({ space: 12 }) {
        Column({ space: 4 }) {
          Text(this.action?.muscleGroup ?? '')
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.brand_primary'))
          Text('ÁõÆÊ†áËÇåÁæ§')
            .fontSize(11)
            .fontColor($r('app.color.text_hint'))
        }
        .layoutWeight(1)
        .padding(12)
        .backgroundColor($r('app.color.card_background_secondary'))
        .borderRadius(8)
        .alignItems(HorizontalAlign.Center)

        Column({ space: 4 }) {
          Text(this.action?.difficulty ?? '')
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getDifficultyColor(this.action?.difficulty ?? ''))
          Text('ÈöæÂ∫¶Á≠âÁ∫ß')
            .fontSize(11)
            .fontColor($r('app.color.text_hint'))
        }
        .layoutWeight(1)
        .padding(12)
        .backgroundColor($r('app.color.card_background_secondary'))
        .borderRadius(8)
        .alignItems(HorizontalAlign.Center)

        Column({ space: 4 }) {
          Text(this.action?.equipment ?? 'Êó†')
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.color_warning'))
          Text('ÊâÄÈúÄÂô®Ê¢∞')
            .fontSize(11)
            .fontColor($r('app.color.text_hint'))
        }
        .layoutWeight(1)
        .padding(12)
        .backgroundColor($r('app.color.card_background_secondary'))
        .borderRadius(8)
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  DescriptionSection() {
    Column({ space: 12 }) {
      Text('Âä®‰ΩúËØ¥Êòé')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))

      Text(this.action?.description ?? '')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .lineHeight(22)
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  StepsSection() {
    Column({ space: 12 }) {
      Text('Âä®‰ΩúÊ≠•È™§')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))

      Column({ space: 12 }) {
        ForEach(this.action?.steps ?? [], (step: string, index: number) => {
          this.StepItem(step, index + 1)
        })
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  StepItem(step: string, stepNumber: number) {
    Row({ space: 12 }) {
      // Ê≠•È™§ÁºñÂè∑
      Column() {
        Text(stepNumber.toString())
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
      }
      .width(32)
      .height(32)
      .backgroundColor($r('app.color.brand_primary'))
      .borderRadius(16)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)

      // Ê≠•È™§ÂÜÖÂÆπ
      Text(step)
        .fontSize(14)
        .fontColor($r('app.color.text_primary'))
        .lineHeight(22)
        .layoutWeight(1)
    }
    .width('100%')
    .alignItems(VerticalAlign.Top)
  }

  @Builder
  TipsSection() {
    Column({ space: 12 }) {
      Text('Ê≥®ÊÑè‰∫ãÈ°π')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))

      Column({ space: 8 }) {
        ForEach(this.action?.tips ?? [], (tip: string) => {
          Row({ space: 8 }) {
            Text('‚Ä¢')
              .fontSize(16)
              .fontColor($r('app.color.color_warning'))
              .fontWeight(FontWeight.Bold)

            Text(tip)
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .lineHeight(22)
              .layoutWeight(1)
          }
          .width('100%')
          .alignItems(VerticalAlign.Top)
        })
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  /**
   * Ëé∑ÂèñÈöæÂ∫¶Á≠âÁ∫ßÈ¢úËâ≤
   */
  getDifficultyColor(difficulty: string): Resource {
    if (difficulty === 'ÂàùÁ∫ß') {
      return $r('app.color.color_success');
    } else if (difficulty === '‰∏≠Á∫ß') {
      return $r('app.color.color_warning');
    } else if (difficulty === 'È´òÁ∫ß') {
      return $r('app.color.color_danger');
    }
    return $r('app.color.text_hint');
  }
}
