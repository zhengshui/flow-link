/**
 * ç™»å½•é¡µé¢ - Login
 * æ”¯æŒè´¦å·å¯†ç ç™»å½•
 */

import { AuthApiService, LoginData, StorageConst, StorageUtils, toast, UserInfoData } from '@tbs/common';
import { router } from '@kit.ArkUI';
import { ResponseResult } from '@tbs/common/src/main/ets/http/response';

@Entry
@Component
struct LoginPage {
  @State username: string = ''
  @State password: string = ''
  @State isLoading: boolean = false

  /**
   * æ‰§è¡Œç™»å½•
   */
  async login(): Promise<void> {
    if (!this.username) {
      toast('è¯·è¾“å…¥ç”¨æˆ·å');
      return;
    }
    if (!this.password) {
      toast('è¯·è¾“å…¥å¯†ç ');
      return;
    }

    this.isLoading = true;

    try {
      const res: ResponseResult = await AuthApiService.login(this.username, this.password);

      if (res.code === 0 && res.data) {
        const loginData: LoginData = res.data as LoginData;
        const token: string = loginData.token;

        // ä¿å­˜ token
        StorageUtils.saveValueSync(StorageConst.TOKEN, token);

        // è·å–ç”¨æˆ·ä¿¡æ¯
        const userInfoRes: ResponseResult = await AuthApiService.getUserInfo();
        if (userInfoRes.code === 0 && userInfoRes.data) {
          const userInfo: UserInfoData = userInfoRes.data as UserInfoData;
          StorageUtils.saveValueSync(StorageConst.USER_INFO, userInfo);
        }

        toast('ç™»å½•æˆåŠŸ');

        // è·³è½¬åˆ°ä¸»é¡µ
        router.replaceUrl({
          url: 'home/HomePage'
        }).catch((err: Error) => {
          console.error('è·³è½¬å¤±è´¥:', JSON.stringify(err));
        });
      } else {
        toast(res.message ?? 'ç™»å½•å¤±è´¥');
      }
    } catch (err) {
      console.error('ç™»å½•å¤±è´¥:', JSON.stringify(err));
      toast('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * è·³è½¬åˆ°æ³¨å†Œé¡µ
   */
  goToRegister(): void {
    router.pushUrl({
      url: 'pages/RegisterPage'
    }).catch((err: Error) => {
      console.error('è·³è½¬å¤±è´¥:', JSON.stringify(err));
    });
  }

  build() {
    Column({ space: 20 }) {
      // é¡¶éƒ¨Logoå’Œæ ‡é¢˜
      Column({ space: 16 }) {
        // Logo
        Text('ğŸ’ª')
          .fontSize(80)
          .margin({ top: 80 })

        // åº”ç”¨åç§°
        Text('FitEasy')
          .fontSize(32)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')

        // æ¬¢è¿è¯­
        Text('å¥èº«æ˜“ - è®©å¥èº«æ›´ç®€å•')
          .fontSize(16)
          .fontColor('#999999')
      }
      .width('100%')

      // è¡¨å•åŒºåŸŸ
      Column({ space: 16 }) {
        // ç”¨æˆ·åè¾“å…¥æ¡†
        TextInput({ placeholder: 'è¯·è¾“å…¥ç”¨æˆ·å' })
          .width('100%')
          .height(48)
          .backgroundColor(Color.White)
          .borderRadius(8)
          .onChange((value: string) => {
            this.username = value;
          })

        // å¯†ç è¾“å…¥æ¡†
        TextInput({ placeholder: 'è¯·è¾“å…¥å¯†ç ' })
          .width('100%')
          .height(48)
          .type(InputType.Password)
          .backgroundColor(Color.White)
          .borderRadius(8)
          .onChange((value: string) => {
            this.password = value;
          })

        // ç™»å½•æŒ‰é’®
        Button(this.isLoading ? 'ç™»å½•ä¸­...' : 'ç™»å½•')
          .width('100%')
          .height(48)
          .fontSize(16)
          .backgroundColor('#007AFF')
          .borderRadius(8)
          .opacity((this.username.length > 0 && this.password.length > 0 && !this.isLoading) ? 1 : 0.5)
          .enabled(this.username.length > 0 && this.password.length > 0 && !this.isLoading)
          .onClick(() => {
            this.login();
          })
      }
      .width('90%')
      .padding(20)
      .margin({ top: 40 })

      // åº•éƒ¨æç¤º
      Row({ space: 4 }) {
        Text('è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ')
          .fontSize(14)
          .fontColor('#666666')

        Text('ç«‹å³æ³¨å†Œ')
          .fontSize(14)
          .fontColor('#007AFF')
          .fontWeight(FontWeight.Medium)
          .onClick(() => {
            this.goToRegister();
          })
      }

      // æµ‹è¯•è´¦å·æç¤º
      Column({ space: 8 }) {
        Text('æµ‹è¯•è´¦å·')
          .fontSize(12)
          .fontColor('#999999')

        Text('ç”¨æˆ·å: admin æˆ– test')
          .fontSize(11)
          .fontColor('#CCCCCC')

        Text('å¯†ç : 123456')
          .fontSize(11)
          .fontColor('#CCCCCC')
      }
      .margin({ top: 40 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
    .alignItems(HorizontalAlign.Center)
  }
}
