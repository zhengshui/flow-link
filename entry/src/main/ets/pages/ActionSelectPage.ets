/**
 * åŠ¨ä½œé€‰æ‹©é¡µé¢ - Action Select
 * æ”¯æŒå¤šé€‰åŠ¨ä½œï¼ˆæœ€å¤š5ä¸ªï¼‰ï¼Œç”¨äºè®­ç»ƒæ—¶æ·»åŠ åŠ¨ä½œ
 * ä½¿ç”¨ NavDestination ä½œä¸º Navigation å­é¡µé¢
 */

import { ActionModel, MuscleGroupModel, ActionDataService, toast } from '@tbs/common';

const MAX_SELECT_COUNT: number = 5;

/**
 * é€‰ä¸­åŠ¨ä½œæ•°æ®ç±»
 */
class SelectedActionData {
  id: string = '';
  name: string = '';
  muscleGroup: string = '';
  thumbnailUrl: string = '';

  constructor(id: string, name: string, muscleGroup: string, thumbnailUrl: string) {
    this.id = id;
    this.name = name;
    this.muscleGroup = muscleGroup;
    this.thumbnailUrl = thumbnailUrl;
  }
}

/**
 * ç³»ç»Ÿè·¯ç”±è¡¨æ„å»ºå‡½æ•°
 */
@Builder
export function ActionSelectPageBuilder(): void {
  ActionSelectPage()
}

@Component
export struct ActionSelectPage {
  @State muscleGroups: MuscleGroupModel[] = []
  @State currentGroupIndex: number = 0
  @State currentActions: ActionModel[] = []
  @State selectedActions: ActionModel[] = []
  @State selectedActionIds: Set<string> = new Set()
  @StorageProp('topRectHeight') topRectHeight: number = 0
  @StorageProp('bottomRectHeight') bottomRectHeight: number = 0
  private pathStack: NavPathStack = new NavPathStack()

  aboutToAppear(): void {
    this.loadData();
  }

  /**
   * åŠ è½½æ•°æ®
   */
  loadData(): void {
    this.muscleGroups = ActionDataService.getAllMuscleGroups();
    if (this.muscleGroups.length > 0) {
      this.currentActions = this.muscleGroups[0].actions;
    }
  }

  /**
   * åˆ‡æ¢è‚Œè‚‰éƒ¨ä½
   */
  switchMuscleGroup(index: number): void {
    this.currentGroupIndex = index;
    if (index < this.muscleGroups.length) {
      this.currentActions = this.muscleGroups[index].actions;
    }
  }

  /**
   * åˆ‡æ¢åŠ¨ä½œé€‰ä¸­çŠ¶æ€
   */
  toggleActionSelection(action: ActionModel): void {
    if (this.selectedActionIds.has(action.id)) {
      // å–æ¶ˆé€‰ä¸­
      this.selectedActionIds.delete(action.id);
      const newSelected: ActionModel[] = [];
      for (let i: number = 0; i < this.selectedActions.length; i++) {
        if (this.selectedActions[i].id !== action.id) {
          newSelected.push(this.selectedActions[i]);
        }
      }
      this.selectedActions = newSelected;
      // è§¦å‘é‡æ–°æ¸²æŸ“
      this.selectedActionIds = new Set(this.selectedActionIds);
    } else {
      // æ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å¤§æ•°é‡
      if (this.selectedActions.length >= MAX_SELECT_COUNT) {
        toast('æœ€å¤šåªèƒ½é€‰æ‹© ' + MAX_SELECT_COUNT.toString() + ' ä¸ªåŠ¨ä½œ');
        return;
      }
      // æ·»åŠ é€‰ä¸­
      this.selectedActionIds.add(action.id);
      this.selectedActions.push(action);
      // è§¦å‘é‡æ–°æ¸²æŸ“
      this.selectedActionIds = new Set(this.selectedActionIds);
    }
  }

  /**
   * æ£€æŸ¥åŠ¨ä½œæ˜¯å¦è¢«é€‰ä¸­
   */
  isActionSelected(actionId: string): boolean {
    return this.selectedActionIds.has(actionId);
  }

  /**
   * ç¡®è®¤é€‰æ‹©
   */
  confirmSelection(): void {
    if (this.selectedActions.length === 0) {
      toast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåŠ¨ä½œ');
      return;
    }

    // å°†é€‰ä¸­çš„åŠ¨ä½œåºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²ä¼ é€’
    const selectedData: SelectedActionData[] = [];
    for (let i: number = 0; i < this.selectedActions.length; i++) {
      const action: ActionModel = this.selectedActions[i];
      const actionData: SelectedActionData = new SelectedActionData(
        action.id,
        action.name,
        action.muscleGroup,
        action.thumbnailUrl
      );
      selectedData.push(actionData);
    }

    // ä½¿ç”¨ JSON å­—ç¬¦ä¸²ä¼ é€’æ•°æ®ï¼Œç¡®ä¿ç±»å‹å…¼å®¹
    const jsonStr: string = JSON.stringify(selectedData);
    AppStorage.setOrCreate<string>('selectedActionsJson', jsonStr);

    this.pathStack.pop();
  }

  build() {
    NavDestination() {
      Column() {
        // ä¸»å†…å®¹åŒºåŸŸ - å·¦å³å¸ƒå±€
        Row() {
          // å·¦ä¾§ï¼šè‚Œè‚‰éƒ¨ä½åˆ—è¡¨
          this.MuscleGroupList()

          // å³ä¾§ï¼šåŠ¨ä½œåˆ—è¡¨
          this.ActionList()
        }
        .width('100%')
        .layoutWeight(1)

        // åº•éƒ¨ç¡®è®¤æ 
        this.BottomBar()
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')
    }
    .title('é€‰æ‹©åŠ¨ä½œ')
    .menus([
      {
        value: this.selectedActions.length.toString() + '/' + MAX_SELECT_COUNT.toString(),
        action: (): void => {}
      }
    ])
    .onReady((context: NavDestinationContext) => {
      this.pathStack = context.pathStack
    })
  }

  @Builder
  MuscleGroupList() {
    Scroll() {
      Column({ space: 0 }) {
        ForEach(this.muscleGroups, (group: MuscleGroupModel, index: number) => {
          this.MuscleGroupItem(group, index)
        })
      }
      .width('100%')
    }
    .width(100)
    .height('100%')
    .backgroundColor(Color.White)
    .scrollBar(BarState.Off)
  }

  @Builder
  MuscleGroupItem(group: MuscleGroupModel, index: number) {
    Column({ space: 4 }) {
      Text(group.icon)
        .fontSize(24)

      Text(group.name)
        .fontSize(12)
        .fontColor(this.currentGroupIndex === index ? '#007AFF' : '#666666')
        .fontWeight(this.currentGroupIndex === index ? FontWeight.Medium : FontWeight.Normal)
    }
    .width('100%')
    .height(80)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .backgroundColor(this.currentGroupIndex === index ? '#E3F2FD' : Color.White)
    .onClick(() => {
      this.switchMuscleGroup(index);
    })
  }

  @Builder
  ActionList() {
    Scroll() {
      Column({ space: 12 }) {
        // éƒ¨ä½æ ‡é¢˜
        Row() {
          Text(this.muscleGroups[this.currentGroupIndex]?.name ?? '')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
          Blank()
          Text(this.currentActions.length.toString() + ' ä¸ªåŠ¨ä½œ')
            .fontSize(13)
            .fontColor('#999999')
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 16 })

        // åŠ¨ä½œåˆ—è¡¨
        Column({ space: 12 }) {
          ForEach(this.currentActions, (action: ActionModel) => {
            this.ActionItem(action)
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 16 })
      }
      .width('100%')
    }
    .layoutWeight(1)
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  ActionItem(action: ActionModel) {
    Row({ space: 12 }) {
      // é€‰æ‹©æ¡†
      Text(this.isActionSelected(action.id) ? 'âœ…' : 'â­•')
        .fontSize(22)
        .fontColor(this.isActionSelected(action.id) ? '#007AFF' : '#CCCCCC')

      // åŠ¨ä½œç¼©ç•¥å›¾
      Column() {
        Text('ğŸ‹ï¸')
          .fontSize(28)
      }
      .width(60)
      .height(60)
      .backgroundColor(this.isActionSelected(action.id) ? '#E3F2FD' : '#E8E8E8')
      .borderRadius(8)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)

      // åŠ¨ä½œä¿¡æ¯
      Column({ space: 4 }) {
        Text(action.name)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.isActionSelected(action.id) ? '#007AFF' : '#333333')

        Text(action.englishName)
          .fontSize(11)
          .fontColor('#999999')

        Row({ space: 8 }) {
          Text(action.difficulty)
            .fontSize(10)
            .fontColor(Color.White)
            .backgroundColor(this.getDifficultyColor(action.difficulty))
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(3)

          if (action.equipment.length > 0) {
            Text(action.equipment)
              .fontSize(10)
              .fontColor('#666666')
          }
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .padding(12)
    .backgroundColor(this.isActionSelected(action.id) ? '#F0F7FF' : Color.White)
    .borderRadius(12)
    .border({ width: this.isActionSelected(action.id) ? 2 : 0, color: '#007AFF' })
    .alignItems(VerticalAlign.Center)
    .onClick(() => {
      this.toggleActionSelection(action);
    })
  }

  @Builder
  BottomBar() {
    Column({ space: 8 }) {
      // å·²é€‰åŠ¨ä½œé¢„è§ˆ
      if (this.selectedActions.length > 0) {
        Scroll() {
          Row({ space: 8 }) {
            ForEach(this.selectedActions, (action: ActionModel) => {
              this.SelectedActionTag(action)
            })
          }
          .padding({ left: 16, right: 16 })
        }
        .width('100%')
        .height(40)
        .scrollable(ScrollDirection.Horizontal)
        .scrollBar(BarState.Off)
      }

      // ç¡®è®¤æŒ‰é’®
      Row({ space: 12 }) {
        Button('å–æ¶ˆ')
          .layoutWeight(1)
          .height(44)
          .fontSize(16)
          .backgroundColor('#E0E0E0')
          .fontColor('#333333')
          .borderRadius(8)
          .onClick(() => {
            this.pathStack.pop();
          })

        Button('ç¡®è®¤æ·»åŠ  (' + this.selectedActions.length.toString() + ')')
          .layoutWeight(2)
          .height(44)
          .fontSize(16)
          .backgroundColor(this.selectedActions.length > 0 ? '#007AFF' : '#CCCCCC')
          .borderRadius(8)
          .enabled(this.selectedActions.length > 0)
          .onClick(() => {
            this.confirmSelection();
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16 })

      // åº•éƒ¨å¯¼èˆªåŒºåŸŸé¿è®©
      Row()
        .width('100%')
        .height(this.getUIContext().px2vp(this.bottomRectHeight))
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding({ top: 12 })
  }

  @Builder
  SelectedActionTag(action: ActionModel) {
    Row({ space: 4 }) {
      Text(action.name)
        .fontSize(12)
        .fontColor('#007AFF')

      Text('âœ•')
        .fontSize(12)
        .fontColor('#999999')
        .onClick(() => {
          this.toggleActionSelection(action);
        })
    }
    .padding({ left: 10, right: 10, top: 6, bottom: 6 })
    .backgroundColor('#E3F2FD')
    .borderRadius(16)
  }

  /**
   * è·å–éš¾åº¦ç­‰çº§é¢œè‰²
   */
  getDifficultyColor(difficulty: string): string {
    if (difficulty === 'åˆçº§') {
      return '#4CAF50';
    } else if (difficulty === 'ä¸­çº§') {
      return '#FF9800';
    } else if (difficulty === 'é«˜çº§') {
      return '#F44336';
    }
    return '#999999';
  }
}
