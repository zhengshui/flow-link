/**
 * åŠ¨ä½œåº“é¡µé¢ - Exercise
 * æŒ‰è‚Œè‚‰éƒ¨ä½åˆ†ç»„æ˜¾ç¤ºè®­ç»ƒåŠ¨ä½œï¼Œå·¦å³å¸ƒå±€
 */

import { ActionModel, MuscleGroupModel, ActionDataService } from '@tbs/common';
import { router } from '@kit.ArkUI';

@Component
export struct ExercisePage {
  @State muscleGroups: MuscleGroupModel[] = []
  @State currentGroupIndex: number = 0
  @State currentActions: ActionModel[] = []

  aboutToAppear(): void {
    this.loadData();
  }

  /**
   * åŠ è½½æ•°æ®
   */
  loadData(): void {
    this.muscleGroups = ActionDataService.getAllMuscleGroups();
    if (this.muscleGroups.length > 0) {
      this.currentActions = this.muscleGroups[0].actions;
    }
  }

  /**
   * åˆ‡æ¢è‚Œè‚‰éƒ¨ä½
   */
  switchMuscleGroup(index: number): void {
    this.currentGroupIndex = index;
    if (index < this.muscleGroups.length) {
      this.currentActions = this.muscleGroups[index].actions;
    }
  }

  /**
   * è·³è½¬åˆ°åŠ¨ä½œè¯¦æƒ…é¡µ
   */
  goToActionDetail(action: ActionModel): void {
    router.pushUrl({
      url: 'pages/ExerciseDetailPage',
      params: {
        actionId: action.id
      }
    }).catch((err: Error) => {
      console.error('è·³è½¬å¤±è´¥:', JSON.stringify(err));
    });
  }

  build() {
    Column() {
      // ä¸»å†…å®¹åŒºåŸŸ - å·¦å³å¸ƒå±€
      Row() {
        // å·¦ä¾§ï¼šè‚Œè‚‰éƒ¨ä½åˆ—è¡¨
        this.MuscleGroupList()

        // å³ä¾§ï¼šåŠ¨ä½œåˆ—è¡¨
        this.ActionList()
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  MuscleGroupList() {
    Scroll() {
      Column({ space: 0 }) {
        ForEach(this.muscleGroups, (group: MuscleGroupModel, index: number) => {
          this.MuscleGroupItem(group, index)
        })
      }
      .width('100%')
    }
    .width(100)
    .height('100%')
    .backgroundColor(Color.White)
    .scrollBar(BarState.Off)
  }

  @Builder
  MuscleGroupItem(group: MuscleGroupModel, index: number) {
    Column({ space: 4 }) {
      Text(group.icon)
        .fontSize(24)

      Text(group.name)
        .fontSize(12)
        .fontColor(this.currentGroupIndex === index ? '#007AFF' : '#666666')
        .fontWeight(this.currentGroupIndex === index ? FontWeight.Medium : FontWeight.Normal)
    }
    .width('100%')
    .height(80)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .backgroundColor(this.currentGroupIndex === index ? '#E3F2FD' : Color.White)
    .onClick(() => {
      this.switchMuscleGroup(index);
    })
  }

  @Builder
  ActionList() {
    Scroll() {
      Column({ space: 12 }) {
        // éƒ¨ä½æ ‡é¢˜
        Row() {
          Text(this.muscleGroups[this.currentGroupIndex]?.name ?? '')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
          Blank()
          Text(this.currentActions.length.toString() + ' ä¸ªåŠ¨ä½œ')
            .fontSize(13)
            .fontColor('#999999')
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 16 })

        // åŠ¨ä½œåˆ—è¡¨
        Column({ space: 12 }) {
          ForEach(this.currentActions, (action: ActionModel) => {
            this.ActionItem(action)
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 16 })
      }
      .width('100%')
    }
    .layoutWeight(1)
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  ActionItem(action: ActionModel) {
    Row({ space: 12 }) {
      // åŠ¨ä½œç¼©ç•¥å›¾
      Column() {
        Text('ğŸ‹ï¸')
          .fontSize(32)
      }
      .width(80)
      .height(80)
      .backgroundColor('#E8E8E8')
      .borderRadius(8)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)

      // åŠ¨ä½œä¿¡æ¯
      Column({ space: 6 }) {
        Text(action.name)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')

        Text(action.englishName)
          .fontSize(12)
          .fontColor('#999999')

        Row({ space: 8 }) {
          Text(action.difficulty)
            .fontSize(11)
            .fontColor(Color.White)
            .backgroundColor(this.getDifficultyColor(action.difficulty))
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(3)

          if (action.equipment.length > 0) {
            Text('å™¨æ¢°: ' + action.equipment)
              .fontSize(11)
              .fontColor('#666666')
          }
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // ç®­å¤´å›¾æ ‡
      Text('>')
        .fontSize(18)
        .fontColor('#CCCCCC')
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(VerticalAlign.Center)
    .onClick(() => {
      this.goToActionDetail(action);
    })
  }

  /**
   * è·å–éš¾åº¦ç­‰çº§é¢œè‰²
   */
  getDifficultyColor(difficulty: string): string {
    if (difficulty === 'åˆçº§') {
      return '#4CAF50';
    } else if (difficulty === 'ä¸­çº§') {
      return '#FF9800';
    } else if (difficulty === 'é«˜çº§') {
      return '#F44336';
    }
    return '#999999';
  }
}
