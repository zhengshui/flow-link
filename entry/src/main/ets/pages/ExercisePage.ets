/**
 * åŠ¨ä½œåº“é¡µé¢ - Exercise
 * æŒ‰è‚Œè‚‰éƒ¨ä½åˆ†ç»„æ˜¾ç¤ºè®­ç»ƒåŠ¨ä½œï¼Œå·¦å³å¸ƒå±€
 */

import { ActionModel, MuscleGroupModel, ActionDataService, RouterManager, NavRoutes, NavRouteParams } from '@tbs/common';

@Component
export struct ExercisePage {
  @State muscleGroups: MuscleGroupModel[] = []
  @State currentGroupIndex: number = 0
  @State currentActions: ActionModel[] = []
  @StorageProp('topRectHeight') topRectHeight: number = 0

  aboutToAppear(): void {
    this.loadData();
  }

  /**
   * åŠ è½½æ•°æ®
   */
  loadData(): void {
    this.muscleGroups = ActionDataService.getAllMuscleGroups();
    if (this.muscleGroups.length > 0) {
      this.currentActions = this.muscleGroups[0].actions;
    }
  }

  /**
   * åˆ‡æ¢è‚Œè‚‰éƒ¨ä½
   */
  switchMuscleGroup(index: number): void {
    this.currentGroupIndex = index;
    if (index < this.muscleGroups.length) {
      this.currentActions = this.muscleGroups[index].actions;
    }
  }

  /**
   * è·³è½¬åˆ°åŠ¨ä½œè¯¦æƒ…é¡µ
   */
  goToActionDetail(action: ActionModel): void {
    const params: NavRouteParams = {
      actionId: action.id
    };
    RouterManager.pushPath(NavRoutes.EXERCISE_DETAIL, params);
  }

  build() {
    Column() {
      // ä¸»å†…å®¹åŒºåŸŸ - å·¦å³å¸ƒå±€
      Row() {
        // å·¦ä¾§ï¼šè‚Œè‚‰éƒ¨ä½åˆ—è¡¨
        this.MuscleGroupList()

        // å³ä¾§ï¼šåŠ¨ä½œåˆ—è¡¨
        this.ActionList()
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.page_background'))
    // é¡¶éƒ¨çŠ¶æ€æ é¿è®©
    .padding({ top: this.getUIContext().px2vp(this.topRectHeight) })
  }

  @Builder
  MuscleGroupList() {
    Scroll() {
      Column({ space: 0 }) {
        ForEach(this.muscleGroups, (group: MuscleGroupModel, index: number) => {
          this.MuscleGroupItem(group, index)
        })
      }
      .width('100%')
    }
    .width(100)
    .height('100%')
    .backgroundColor($r('app.color.card_background'))
    .scrollBar(BarState.Off)
  }

  @Builder
  MuscleGroupItem(group: MuscleGroupModel, index: number) {
    Column({ space: 4 }) {
      // è‚Œè‚‰éƒ¨ä½å›¾æ ‡
      Text(group.icon)
        .fontSize(22)

      Text(group.name)
        .fontSize(12)
        .fontColor(this.currentGroupIndex === index ? $r('app.color.brand_primary') : $r('app.color.text_secondary'))
        .fontWeight(this.currentGroupIndex === index ? FontWeight.Medium : FontWeight.Normal)
    }
    .width('100%')
    .height(72)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .backgroundColor(this.currentGroupIndex === index ? $r('app.color.brand_primary_light') : $r('app.color.card_background'))
    .borderRadius(this.currentGroupIndex === index ? 8 : 0)
    .onClick(() => {
      this.switchMuscleGroup(index);
    })
  }

  @Builder
  ActionList() {
    Scroll() {
      Column({ space: 12 }) {
        // éƒ¨ä½æ ‡é¢˜
        Row() {
          Text(this.muscleGroups[this.currentGroupIndex]?.name ?? '')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))
          Blank()
          Text(this.currentActions.length.toString() + ' ä¸ªåŠ¨ä½œ')
            .fontSize(13)
            .fontColor($r('app.color.text_hint'))
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 16 })

        // åŠ¨ä½œåˆ—è¡¨
        Column({ space: 12 }) {
          ForEach(this.currentActions, (action: ActionModel) => {
            this.ActionItem(action)
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 16 })
      }
      .width('100%')
    }
    .layoutWeight(1)
    .height('100%')
    .backgroundColor($r('app.color.page_background'))
  }

  @Builder
  ActionItem(action: ActionModel) {
    Row({ space: 12 }) {
      // åŠ¨ä½œç¼©ç•¥å›¾ - ä½¿ç”¨è‚Œç¾¤å¯¹åº”å›¾æ ‡
      Column() {
        Text(this.getMuscleGroupIcon(action.muscleGroup))
          .fontSize(28)
      }
      .width(56)
      .height(56)
      .backgroundColor(this.getMuscleGroupColor(action.muscleGroup))
      .borderRadius(12)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)

      // åŠ¨ä½œä¿¡æ¯
      Column({ space: 4 }) {
        Text(action.name)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))

        Text(action.englishName)
          .fontSize(11)
          .fontColor($r('app.color.text_hint'))

        Row({ space: 8 }) {
          Text(action.difficulty)
            .fontSize(10)
            .fontColor(Color.White)
            .backgroundColor(this.getDifficultyColor(action.difficulty))
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(3)

          if (action.equipment.length > 0) {
            Text(action.equipment)
              .fontSize(10)
              .fontColor($r('app.color.text_secondary'))
          }
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // ç®­å¤´å›¾æ ‡
      SymbolGlyph($r('sys.symbol.chevron_right'))
        .fontSize(16)
        .fontColor([$r('app.color.text_placeholder')])
    }
    .width('100%')
    .padding(12)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(12)
    .alignItems(VerticalAlign.Center)
    .onClick(() => {
      this.goToActionDetail(action);
    })
  }

  /**
   * è·å–éš¾åº¦ç­‰çº§é¢œè‰²
   */
  getDifficultyColor(difficulty: string): string {
    if (difficulty === 'åˆçº§') {
      return '#4CAF50';
    } else if (difficulty === 'ä¸­çº§') {
      return '#FF9800';
    } else if (difficulty === 'é«˜çº§') {
      return '#F44336';
    }
    return '#999999';
  }

  /**
   * è·å–éš¾åº¦ç­‰çº§èƒŒæ™¯è‰²ï¼ˆè¾ƒæµ…ï¼‰
   */
  getDifficultyBgColor(difficulty: string): string {
    if (difficulty === 'åˆçº§') {
      return '#66BB6A';
    } else if (difficulty === 'ä¸­çº§') {
      return '#FFA726';
    } else if (difficulty === 'é«˜çº§') {
      return '#EF5350';
    }
    return '#BDBDBD';
  }

  /**
   * æ ¹æ®è‚Œè‚‰éƒ¨ä½åç§°è·å–å¯¹åº”å›¾æ ‡
   */
  getMuscleGroupIcon(muscleGroup: string): string {
    if (muscleGroup === 'èƒ¸è‚Œ') {
      return 'ğŸ’ª';
    } else if (muscleGroup === 'èƒŒè‚Œ') {
      return 'ğŸ¦¾';
    } else if (muscleGroup === 'è…¿éƒ¨') {
      return 'ğŸ¦µ';
    } else if (muscleGroup === 'è‚©éƒ¨') {
      return 'ğŸ¤¸';
    } else if (muscleGroup === 'äºŒå¤´è‚Œ') {
      return 'ğŸ’ª';
    } else if (muscleGroup === 'ä¸‰å¤´è‚Œ') {
      return 'ğŸ’ª';
    } else if (muscleGroup === 'å°è…¿') {
      return 'ğŸ¦¿';
    } else if (muscleGroup === 'è‡€éƒ¨') {
      return 'ğŸ‘';
    } else if (muscleGroup === 'è…¹è‚Œ') {
      return 'ğŸ¯';
    }
    return 'ğŸ’ª';
  }

  /**
   * æ ¹æ®è‚Œè‚‰éƒ¨ä½åç§°è·å–å¯¹åº”èƒŒæ™¯è‰²
   */
  getMuscleGroupColor(muscleGroup: string): string {
    if (muscleGroup === 'èƒ¸è‚Œ') {
      return '#E57373'; // çº¢è‰²ç³»
    } else if (muscleGroup === 'èƒŒè‚Œ') {
      return '#64B5F6'; // è“è‰²ç³»
    } else if (muscleGroup === 'è…¿éƒ¨') {
      return '#81C784'; // ç»¿è‰²ç³»
    } else if (muscleGroup === 'è‚©éƒ¨') {
      return '#FFB74D'; // æ©™è‰²ç³»
    } else if (muscleGroup === 'äºŒå¤´è‚Œ') {
      return '#BA68C8'; // ç´«è‰²ç³»
    } else if (muscleGroup === 'ä¸‰å¤´è‚Œ') {
      return '#9575CD'; // æ·±ç´«è‰²ç³»
    } else if (muscleGroup === 'å°è…¿') {
      return '#4DB6AC'; // é’è‰²ç³»
    } else if (muscleGroup === 'è‡€éƒ¨') {
      return '#F06292'; // ç²‰è‰²ç³»
    } else if (muscleGroup === 'è…¹è‚Œ') {
      return '#FFD54F'; // é»„è‰²ç³»
    }
    return '#90A4AE'; // é»˜è®¤ç°è‰²
  }
}
