/**
 * è®­ç»ƒè®°å½•é¡µé¢ - Record
 * æŒ‰æ—¥æœŸåˆ—è¡¨æ˜¾ç¤ºè®­ç»ƒè®°å½•ï¼Œæ”¯æŒæ·»åŠ ã€ä¿®æ”¹å’Œåˆ é™¤
 */

import { TrainingRecordModel, TrainingApiService, toast, ExerciseModel } from '@tbs/common';
import { promptAction } from '@kit.ArkUI';
import { ResponseResult } from '@tbs/common/src/main/ets/http/response';

@Component
export struct RecordPage {
  @State records: TrainingRecordModel[] = []
  @State isLoading: boolean = false

  aboutToAppear(): void {
    this.loadRecords();
  }

  /**
   * åŠ è½½è®­ç»ƒè®°å½•
   */
  async loadRecords(): Promise<void> {
    this.isLoading = true;
    try {
      const res: ResponseResult = await TrainingApiService.getTrainingRecords(1, 100);
      if (res.code === 0 && res.data) {
        const apiData: Record<string, Object> = res.data as Record<string, Object>;
        const recordsArray: Object = apiData['records'] ?? [];
        this.records = recordsArray as TrainingRecordModel[];
      } else {
        toast(res.message ?? 'åŠ è½½å¤±è´¥');
      }
    } catch (err) {
      console.error('åŠ è½½è®­ç»ƒè®°å½•å¤±è´¥:', JSON.stringify(err));
      toast('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * åˆ é™¤è®­ç»ƒè®°å½•
   */
  async deleteRecord(recordId: number): Promise<void> {
    try {
      const res: ResponseResult = await TrainingApiService.deleteTrainingRecord(recordId.toString());
      if (res.code === 0) {
        // ä»åˆ—è¡¨ä¸­ç§»é™¤å·²åˆ é™¤çš„è®°å½•
        const newRecords: TrainingRecordModel[] = [];
        for (let i: number = 0; i < this.records.length; i++) {
          if (this.records[i].id !== recordId) {
            newRecords.push(this.records[i]);
          }
        }
        this.records = newRecords;
        toast('åˆ é™¤æˆåŠŸ');
      } else {
        toast(res.message ?? 'åˆ é™¤å¤±è´¥');
      }
    } catch (err) {
      console.error('åˆ é™¤è®­ç»ƒè®°å½•å¤±è´¥:', JSON.stringify(err));
      toast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  /**
   * æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
   */
  showDeleteDialog(record: TrainingRecordModel): void {
    promptAction.showDialog({
      title: 'ç¡®è®¤åˆ é™¤',
      message: 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è®­ç»ƒè®°å½•å—ï¼Ÿ',
      buttons: [
        {
          text: 'å–æ¶ˆ',
          color: '#666666'
        },
        {
          text: 'åˆ é™¤',
          color: '#FF0000'
        }
      ]
    }).then((data: promptAction.ShowDialogSuccessResponse) => {
      if (data.index === 1) {
        this.deleteRecord(record.id);
      }
    }).catch(() => {
      console.error('Dialog error');
    });
  }

  build() {
    Column() {
      // ä¸»å†…å®¹åŒºåŸŸ
      if (this.records.length > 0) {
        // æ˜¾ç¤ºè®°å½•åˆ—è¡¨
        List({ space: 12 }) {
          ForEach(this.records, (record: TrainingRecordModel) => {
            ListItem() {
              this.RecordCard(record)
            }
          })
        }
        .width('100%')
        .layoutWeight(1)
        .padding(16)
        .backgroundColor('#F5F5F5')
      } else {
        // ç©ºçŠ¶æ€æç¤º
        Scroll() {
          Column({ space: 16 }) {
            Text('ğŸ“')
              .fontSize(48)

            Text('è¿˜æ²¡æœ‰è®­ç»ƒè®°å½•')
              .fontSize(16)
              .fontColor('#666666')

            Text('ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹è®°å½•æ‚¨çš„ç¬¬ä¸€æ¬¡è®­ç»ƒ')
              .fontSize(14)
              .fontColor('#999999')
          }
          .width('100%')
          .margin({ top: 100 })
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        }
        .layoutWeight(1)
      }

      // åº•éƒ¨æ·»åŠ æŒ‰é’®
      Button('æ·»åŠ è®­ç»ƒè®°å½•')
        .width('90%')
        .height(48)
        .fontSize(16)
        .backgroundColor('#007AFF')
        .borderRadius(8)
        .margin({ bottom: 16 })
        .onClick(() => {
          toast('æ·»åŠ åŠŸèƒ½å¼€å‘ä¸­...');
        })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  RecordCard(record: TrainingRecordModel) {
    Column({ space: 12 }) {
      // æ ‡é¢˜å’Œæ—¥æœŸ
      Row() {
        Column({ space: 4 }) {
          Text(record.title)
            .fontSize(17)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
          Text(record.date + ' ' + record.startTime)
            .fontSize(12)
            .fontColor('#999999')
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        // åˆ é™¤æŒ‰é’®
        Button('åˆ é™¤')
          .fontSize(13)
          .height(28)
          .backgroundColor('#FF4444')
          .borderRadius(6)
          .onClick(() => {
            this.showDeleteDialog(record);
          })
      }
      .width('100%')

      // åˆ†å‰²çº¿
      Divider()
        .color('#F0F0F0')

      // è®­ç»ƒæ•°æ®
      Row({ space: 16 }) {
        this.DataTag('æ—¶é•¿', record.duration.toString() + 'åˆ†é’Ÿ', '#4CAF50')
        this.DataTag('ç»„æ•°', record.totalSets.toString() + 'ç»„', '#FF9800')
        this.DataTag('é‡é‡', (record.totalWeight / 1000).toFixed(1) + 'T', '#2196F3')
        this.DataTag('å¡è·¯é‡Œ', record.caloriesBurned.toString(), '#F44336')
      }
      .width('100%')

      // è®­ç»ƒé¡¹ç›®
      if (record.exercises.length > 0) {
        Column({ space: 6 }) {
          Text('è®­ç»ƒé¡¹ç›®:')
            .fontSize(12)
            .fontColor('#666666')

          Column({ space: 4 }) {
            ForEach(record.exercises, (exercise: ExerciseModel, index: number) => {
              Text((index + 1).toString() + '. ' + exercise.name +
                ' (' + exercise.sets.toString() + 'ç»„ x ' +
                exercise.reps.toString() + 'æ¬¡ x ' +
                exercise.weight.toString() + 'kg)')
                .fontSize(12)
                .fontColor('#333333')
            })
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)
        .padding({ top: 8 })
      }

      // å¤‡æ³¨å’ŒçŠ¶æ€
      if (record.notes.length > 0 || record.mood.length > 0) {
        Row({ space: 8 }) {
          if (record.mood.length > 0) {
            Text('çŠ¶æ€: ' + record.mood)
              .fontSize(12)
              .fontColor('#666666')
          }
          if (record.notes.length > 0) {
            Text('|')
              .fontSize(12)
              .fontColor('#CCCCCC')
            Text(record.notes)
              .fontSize(12)
              .fontColor('#666666')
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .layoutWeight(1)
          }
        }
        .width('100%')
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  DataTag(label: string, value: string, color: string) {
    Column({ space: 2 }) {
      Text(value)
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)
      Text(label)
        .fontSize(10)
        .fontColor('#999999')
    }
    .alignItems(HorizontalAlign.Center)
  }
}
