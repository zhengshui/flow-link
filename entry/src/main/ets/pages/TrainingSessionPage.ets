/**
 * è®­ç»ƒä¼šè¯é¡µé¢ - Training Session
 * å®æ—¶è®°å½•è®­ç»ƒè¿‡ç¨‹ï¼Œæ”¯æŒè®¡æ—¶ã€åŠ¨ä½œç®¡ç†ã€ç»„è®°å½•ç­‰åŠŸèƒ½
 */

import {
  TrainingSessionModel,
  SessionExerciseModel,
  TrainingSetModel,
  SetTypeConst,
  toast,
  TrainingApiService,
  TrainingRecordModel,
  ExerciseModel
} from '@tbs/common';
import { router, promptAction } from '@kit.ArkUI';
import { ResponseResult } from '@tbs/common/src/main/ets/http/response';
import {
  SessionExerciseCard,
  SetTypeSelectDialog,
  TrainingFeedbackSection
} from './training/index';

/**
 * é€‰ä¸­åŠ¨ä½œæ•°æ®ç±»ï¼ˆä¸ ActionSelectPage å…±äº«ï¼‰
 */
class SelectedActionData {
  id: string = '';
  name: string = '';
  muscleGroup: string = '';
  thumbnailUrl: string = '';
}

@Entry
@Component
struct TrainingSessionPage {
  @State session: TrainingSessionModel = new TrainingSessionModel()
  @State currentTime: string = '00:00'
  @State timerInterval: number = -1
  @State pauseStartTime: number = 0
  @State showNoteDialog: boolean = false
  @State tempNote: string = ''
  @State isSaving: boolean = false
  @State showSetTypeMenu: boolean = false
  @State currentEditExerciseIndex: number = -1
  @State currentEditSetIndex: number = -1
  @State isLoadingRecord: boolean = false
  @State existingRecordId: string = ''
  @State selectedDate: string = '' // ç”¨æˆ·é€‰æ‹©çš„è®­ç»ƒæ—¥æœŸï¼ˆä»æ—¥å†ä¼ å…¥ï¼Œæ ¼å¼ YYYY-MM-DDï¼‰
  @State showTimeEditDialog: boolean = false
  @State editHours: string = '0'
  @State editMinutes: string = '0'
  @State editSeconds: string = '0'

  aboutToAppear(): void {
    // æ£€æŸ¥æ˜¯å¦æ˜¯ç»§ç»­è®­ç»ƒï¼ˆæœ‰ä¼ å…¥ recordIdï¼‰
    const params: Record<string, Object> = router.getParams() as Record<string, Object>;
    if (params !== null && params !== undefined) {
      // æ£€æŸ¥ç»§ç»­è®­ç»ƒ
      if (params['recordId'] !== undefined) {
        const recordId: string = params['recordId'] as string;
        if (recordId.length > 0) {
          this.existingRecordId = recordId;
          this.loadExistingRecord(recordId);
          return;
        }
      }

      // æ£€æŸ¥å¤åˆ¶åˆ°ä»Šå¤©
      if (params['copyFromRecord'] !== undefined && params['copyFromRecord'] as boolean) {
        this.loadCopiedActions();
        return;
      }

      // æ£€æŸ¥é€‰ä¸­çš„æ—¥æœŸï¼ˆä»æ—¥å†è¿›å…¥ï¼‰
      if (params['selectedDate'] !== undefined) {
        const selectedDateStr: string = params['selectedDate'] as string;
        if (selectedDateStr.length > 0) {
          this.selectedDate = selectedDateStr;
        }
      }
    }

    // æ–°è®­ç»ƒ
    this.initNewSession();
  }

  /**
   * åŠ è½½å¤åˆ¶çš„åŠ¨ä½œï¼ˆå¤åˆ¶åˆ°ä»Šå¤©ï¼‰
   */
  loadCopiedActions(): void {
    const jsonStr: string | undefined = AppStorage.get<string>('copyRecordActionsJson');
    if (jsonStr !== undefined && jsonStr.length > 0) {
      try {
        const actionsData: Object[] = JSON.parse(jsonStr) as Object[];
        const exercises: SessionExerciseModel[] = [];

        for (let i: number = 0; i < actionsData.length; i++) {
          const actionObj: Record<string, Object> = actionsData[i] as Record<string, Object>;
          const sessionEx: SessionExerciseModel = new SessionExerciseModel(
            actionObj['id'] as string ?? '',
            actionObj['name'] as string ?? '',
            actionObj['muscleGroup'] as string ?? '',
            [],
            0,
            actionObj['sets'] as number ?? 4,
            actionObj['reps'] as number ?? 8,
            '',
            ''
          );

          // æ·»åŠ é»˜è®¤è®­ç»ƒç»„
          const sets: number = actionObj['sets'] as number ?? 1;
          const reps: number = actionObj['reps'] as number ?? 8;
          const weight: number = actionObj['weight'] as number ?? 0;
          for (let s: number = 0; s < sets; s++) {
            sessionEx.addSet(SetTypeConst.WORKING, weight, reps);
          }

          exercises.push(sessionEx);
        }

        AppStorage.delete('copyRecordActionsJson');

        this.session = new TrainingSessionModel(
          'è®­ç»ƒè®°å½•',
          Date.now(),
          0,
          exercises,
          '',
          '',
          true,
          0
        );

        this.startTimer();
        toast('å·²åŠ è½½ ' + exercises.length.toString() + ' ä¸ªåŠ¨ä½œ');
      } catch (e) {
        console.error('è§£æå¤åˆ¶åŠ¨ä½œæ•°æ®å¤±è´¥');
        this.initNewSession();
      }
    } else {
      this.initNewSession();
    }
  }

  /**
   * åŠ è½½å·²æœ‰çš„è®­ç»ƒè®°å½•ï¼ˆç»§ç»­è®­ç»ƒï¼‰
   */
  async loadExistingRecord(recordId: string): Promise<void> {
    this.isLoadingRecord = true;
    try {
      const res: ResponseResult = await TrainingApiService.getTrainingRecord(recordId);
      if (res.code === 0 && res.data) {
        const record: TrainingRecordModel = res.data as TrainingRecordModel;
        this.convertRecordToSession(record);
        toast('å·²åŠ è½½è®­ç»ƒè®°å½•ï¼Œå¯ä»¥ç»§ç»­è®­ç»ƒ');
      } else {
        toast(res.message ?? 'åŠ è½½è®­ç»ƒè®°å½•å¤±è´¥');
        // åŠ è½½å¤±è´¥åˆ™ä½œä¸ºæ–°è®­ç»ƒ
        this.initNewSession();
      }
    } catch (err) {
      console.error('åŠ è½½è®­ç»ƒè®°å½•å¤±è´¥:', JSON.stringify(err));
      toast('åŠ è½½å¤±è´¥ï¼Œå¼€å§‹æ–°è®­ç»ƒ');
      this.initNewSession();
    } finally {
      this.isLoadingRecord = false;
    }
  }

  /**
   * å°†è®­ç»ƒè®°å½•è½¬æ¢ä¸ºè®­ç»ƒä¼šè¯
   */
  convertRecordToSession(record: TrainingRecordModel): void {
    const exercises: SessionExerciseModel[] = [];

    // å°† ExerciseModel è½¬æ¢ä¸º SessionExerciseModel
    for (let i: number = 0; i < record.exercises.length; i++) {
      const ex: ExerciseModel = record.exercises[i];
      const sessionEx: SessionExerciseModel = new SessionExerciseModel(
        ex.id.toString(),
        ex.name,
        ex.muscleGroup,
        [],
        0,
        ex.sets,
        ex.reps,
        ex.notes,
        ''
      );

      // æ ¹æ®è®°å½•çš„ç»„æ•°åˆ›å»ºè®­ç»ƒç»„ï¼ˆå·²å®ŒæˆçŠ¶æ€ï¼‰
      for (let s: number = 0; s < ex.sets; s++) {
        const set: TrainingSetModel = new TrainingSetModel(
          SetTypeConst.WORKING,
          ex.weight,
          ex.reps,
          true, // å·²å®Œæˆ
          ''
        );
        sessionEx.sets.push(set);
      }

      exercises.push(sessionEx);
    }

    // è®¡ç®—åŸæ¥çš„è®­ç»ƒæ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰ï¼Œç»§ç»­è®­ç»ƒæ—¶ä»åŸæ¥çš„æ—¶é•¿å¼€å§‹
    const previousDurationMs: number = record.duration * 60 * 1000;
    const adjustedStartTime: number = Date.now() - previousDurationMs;

    // åˆ›å»ºä¼šè¯
    this.session = new TrainingSessionModel(
      record.title,
      adjustedStartTime, // è°ƒæ•´å¼€å§‹æ—¶é—´ï¼Œä½¿æ—¶é•¿æ˜¾ç¤ºä»åŸæ¥çš„æ—¶é•¿å¼€å§‹
      0,
      exercises,
      record.mood,
      record.notes,
      true,
      record.planId
    );

    this.startTimer();
  }

  /**
   * åˆå§‹åŒ–æ–°è®­ç»ƒä¼šè¯
   */
  initNewSession(): void {
    // è®¡ç®—å¼€å§‹æ—¶é—´ï¼šå¦‚æœæœ‰é€‰ä¸­æ—¥æœŸï¼Œä½¿ç”¨é€‰ä¸­æ—¥æœŸ + å½“å‰æ—¶åˆ†ç§’
    this.session.startTime = this.calculateStartTime();
    this.session.isRunning = true;
    this.session.title = 'è®­ç»ƒè®°å½•';
    this.startTimer();
  }

  /**
   * è®¡ç®—å¼€å§‹æ—¶é—´
   * å¦‚æœç”¨æˆ·ä»æ—¥å†é€‰æ‹©äº†æ—¥æœŸï¼Œåˆ™ä½¿ç”¨é€‰ä¸­æ—¥æœŸ + å½“å‰æ—¶åˆ†ç§’
   * å¦åˆ™ä½¿ç”¨å½“å‰å®Œæ•´æ—¶é—´
   */
  calculateStartTime(): number {
    const now: Date = new Date();

    if (this.selectedDate.length > 0) {
      // è§£æé€‰ä¸­çš„æ—¥æœŸ (æ ¼å¼: YYYY-MM-DD)
      const parts: string[] = this.selectedDate.split('-');
      if (parts.length === 3) {
        const year: number = parseInt(parts[0]) || now.getFullYear();
        const month: number = (parseInt(parts[1]) || 1) - 1; // Date æœˆä»½ä»0å¼€å§‹
        const day: number = parseInt(parts[2]) || 1;

        // ä½¿ç”¨é€‰ä¸­æ—¥æœŸ + å½“å‰æ—¶åˆ†ç§’
        const selectedDateTime: Date = new Date(
          year,
          month,
          day,
          now.getHours(),
          now.getMinutes(),
          now.getSeconds()
        );
        return selectedDateTime.getTime();
      }
    }

    // æ²¡æœ‰é€‰ä¸­æ—¥æœŸï¼Œä½¿ç”¨å½“å‰æ—¶é—´
    return now.getTime();
  }

  onPageShow(): void {
    this.checkSelectedActions();
  }

  aboutToDisappear(): void {
    this.stopTimer();
  }

  // ==================== è®¡æ—¶å™¨ç›¸å…³ ====================

  startTimer(): void {
    this.stopTimer();
    this.timerInterval = setInterval((): void => {
      this.updateTimer();
    }, 1000);
  }

  stopTimer(): void {
    if (this.timerInterval !== -1) {
      clearInterval(this.timerInterval);
      this.timerInterval = -1;
    }
  }

  updateTimer(): void {
    const totalSeconds: number = this.session.getDurationInSeconds();
    const hours: number = Math.floor(totalSeconds / 3600);
    const minutes: number = Math.floor((totalSeconds % 3600) / 60);
    const secs: number = totalSeconds % 60;

    const hoursStr: string = hours < 10 ? '0' + hours.toString() : hours.toString();
    const minutesStr: string = minutes < 10 ? '0' + minutes.toString() : minutes.toString();
    const secsStr: string = secs < 10 ? '0' + secs.toString() : secs.toString();

    // å¦‚æœæœ‰å°æ—¶åˆ™æ˜¾ç¤º HH:MM:SSï¼Œå¦åˆ™æ˜¾ç¤º MM:SS
    if (hours > 0) {
      this.currentTime = hoursStr + ':' + minutesStr + ':' + secsStr;
    } else {
      this.currentTime = minutesStr + ':' + secsStr;
    }
  }

  toggleTimer(): void {
    if (this.session.isRunning) {
      this.pauseStartTime = Date.now();
      this.session.isRunning = false;
      this.stopTimer();
    } else {
      if (this.pauseStartTime > 0) {
        this.session.pausedTime += Date.now() - this.pauseStartTime;
        this.pauseStartTime = 0;
      }
      this.session.isRunning = true;
      this.startTimer();
    }
  }

  // ==================== åŠ¨ä½œç®¡ç† ====================

  checkSelectedActions(): void {
    const jsonStr: string | undefined = AppStorage.get<string>('selectedActionsJson');

    if (jsonStr !== undefined && jsonStr.length > 0) {
      try {
        const selectedData: SelectedActionData[] = JSON.parse(jsonStr) as SelectedActionData[];

        if (selectedData.length > 0) {
          let addedCount: number = 0;
          const newExercises: SessionExerciseModel[] = [];

          for (let k: number = 0; k < this.session.exercises.length; k++) {
            newExercises.push(this.session.exercises[k]);
          }

          for (let i: number = 0; i < selectedData.length; i++) {
            const actionData: SelectedActionData = selectedData[i];

            let alreadyExists: boolean = false;
            for (let j: number = 0; j < newExercises.length; j++) {
              if (newExercises[j].actionId === actionData.id) {
                alreadyExists = true;
                break;
              }
            }

            if (!alreadyExists) {
              const newExercise: SessionExerciseModel = new SessionExerciseModel(
                actionData.id, actionData.name, actionData.muscleGroup,
                [], 0, 4, 8, '', actionData.thumbnailUrl
              );
              newExercise.addSet(SetTypeConst.WORKING, 0, 8);
              newExercises.push(newExercise);
              addedCount++;
            }
          }

          AppStorage.delete('selectedActionsJson');

          if (addedCount > 0) {
            this.session = new TrainingSessionModel(
              this.session.title, this.session.startTime, this.session.pausedTime,
              newExercises, this.session.mood, this.session.notes,
              this.session.isRunning, this.session.planId
            );
            toast('å·²æ·»åŠ  ' + addedCount.toString() + ' ä¸ªåŠ¨ä½œ');
          }
        }
      } catch (e) {
        console.error('è§£æé€‰ä¸­åŠ¨ä½œæ•°æ®å¤±è´¥');
      }
    }
  }

  addExercise(): void {
    router.pushUrl({ url: 'pages/ActionSelectPage' }).catch((err: Error): void => {
      console.error('è·³è½¬å¤±è´¥:', JSON.stringify(err));
    });
  }

  removeExercise(index: number): void {
    promptAction.showDialog({
      title: 'åˆ é™¤åŠ¨ä½œ',
      message: 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåŠ¨ä½œå—ï¼Ÿ',
      buttons: [{ text: 'å–æ¶ˆ', color: '#666666' }, { text: 'åˆ é™¤', color: '#FF0000' }]
    }).then((data: promptAction.ShowDialogSuccessResponse): void => {
      if (data.index === 1) {
        this.session.removeExercise(index);
        this.refreshSession();
      }
    }).catch((): void => {});
  }

  // ==================== è®­ç»ƒç»„ç®¡ç† ====================

  addSet(exerciseIndex: number): void {
    const exercise: SessionExerciseModel = this.session.exercises[exerciseIndex];
    const lastSet: TrainingSetModel | null = exercise.sets.length > 0 ?
      exercise.sets[exercise.sets.length - 1] : null;
    const weight: number = lastSet !== null ? lastSet.weight : 0;
    const reps: number = lastSet !== null ? lastSet.reps : exercise.targetReps;
    exercise.addSet(SetTypeConst.WORKING, weight, reps);
    this.refreshSession();
  }

  removeSet(exerciseIndex: number, setIndex: number): void {
    this.session.exercises[exerciseIndex].removeSet(setIndex);
    this.refreshSession();
  }

  toggleSetComplete(exerciseIndex: number, setIndex: number): void {
    const set: TrainingSetModel = this.session.exercises[exerciseIndex].sets[setIndex];
    set.isCompleted = !set.isCompleted;
    this.refreshSession();
  }

  showSetTypeSelector(exerciseIndex: number, setIndex: number): void {
    this.currentEditExerciseIndex = exerciseIndex;
    this.currentEditSetIndex = setIndex;
    this.showSetTypeMenu = true;
  }

  changeSetType(newType: string): void {
    if (this.currentEditExerciseIndex >= 0 && this.currentEditSetIndex >= 0) {
      const set: TrainingSetModel = this.session.exercises[this.currentEditExerciseIndex].sets[this.currentEditSetIndex];
      set.setType = newType;
    }
    this.showSetTypeMenu = false;
    this.currentEditExerciseIndex = -1;
    this.currentEditSetIndex = -1;
    this.refreshSession();
  }

  // ==================== ä¿å­˜è®­ç»ƒ ====================

  async finishTraining(): Promise<void> {
    if (this.session.exercises.length === 0) {
      toast('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªè®­ç»ƒåŠ¨ä½œ');
      return;
    }
    if (this.session.getTotalCompletedSets() === 0) {
      toast('è¯·è‡³å°‘å®Œæˆä¸€ç»„è®­ç»ƒ');
      return;
    }
    this.showFinishDialog();
  }

  showFinishDialog(): void {
    promptAction.showDialog({
      title: 'å®Œæˆè®­ç»ƒ',
      message: 'ç¡®å®šè¦ç»“æŸå¹¶ä¿å­˜æœ¬æ¬¡è®­ç»ƒå—ï¼Ÿ',
      buttons: [{ text: 'å–æ¶ˆ', color: '#666666' }, { text: 'ä¿å­˜', color: '#007AFF' }]
    }).then((data: promptAction.ShowDialogSuccessResponse): void => {
      if (data.index === 1) {
        this.saveTraining();
      }
    }).catch((): void => {});
  }

  async saveTraining(): Promise<void> {
    this.isSaving = true;
    this.stopTimer();
    try {
      const record: TrainingRecordModel = this.convertToTrainingRecord();
      let res: ResponseResult;

      if (this.existingRecordId.length > 0) {
        // ç»§ç»­è®­ç»ƒ - æ›´æ–°å·²æœ‰è®°å½•
        res = await TrainingApiService.updateTrainingRecord(this.existingRecordId, record);
      } else {
        // æ–°è®­ç»ƒ - åˆ›å»ºæ–°è®°å½•
        res = await TrainingApiService.createTrainingRecord(record);
      }

      if (res.code === 0) {
        toast(this.existingRecordId.length > 0 ? 'è®­ç»ƒè®°å½•æ›´æ–°æˆåŠŸ' : 'è®­ç»ƒè®°å½•ä¿å­˜æˆåŠŸ');
        // è®¾ç½®åˆ·æ–°æ ‡å¿—ï¼Œé€šçŸ¥ RecordPage åˆ·æ–°æ•°æ®
        AppStorage.setOrCreate<boolean>('needRefreshRecordPage', true);
        router.back();
      } else {
        toast(res.message ?? 'ä¿å­˜å¤±è´¥');
        this.isSaving = false;
      }
    } catch (err) {
      console.error('ä¿å­˜è®­ç»ƒè®°å½•å¤±è´¥:', JSON.stringify(err));
      toast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
      this.isSaving = false;
    }
  }

  convertToTrainingRecord(): TrainingRecordModel {
    const record: TrainingRecordModel = new TrainingRecordModel();
    record.title = this.session.title;

    // å¼€å§‹æ—¶é—´ï¼ˆä» session.startTime è·å–ï¼ŒåŒ…å«ç”¨æˆ·é€‰æ‹©çš„æ—¥æœŸï¼‰
    const startDate: Date = new Date(this.session.startTime);
    // ç»“æŸæ—¶é—´ï¼ˆå½“å‰æ—¶é—´ï¼‰
    const endDate: Date = new Date();

    // ä»å¼€å§‹æ—¶é—´æå–è®­ç»ƒæ—¥æœŸ (YYYY-MM-DD)
    record.date = startDate.getFullYear().toString() + '-' +
      (startDate.getMonth() + 1 < 10 ? '0' : '') + (startDate.getMonth() + 1).toString() + '-' +
      (startDate.getDate() < 10 ? '0' : '') + startDate.getDate().toString();

    // å¼€å§‹æ—¶é—´å®Œæ•´æ ¼å¼ (YYYY-MM-DD HH:mm:ss)
    record.startTime = this.formatDateTime(startDate);
    // ç»“æŸæ—¶é—´å®Œæ•´æ ¼å¼ (YYYY-MM-DD HH:mm:ss)
    record.endTime = this.formatDateTime(endDate);

    record.duration = this.session.getDuration();
    record.notes = this.session.notes;
    record.mood = this.session.mood;
    record.planId = this.session.planId;

    const exercises: ExerciseModel[] = [];
    for (let i: number = 0; i < this.session.exercises.length; i++) {
      const sessionEx: SessionExerciseModel = this.session.exercises[i];
      const completedSets: number = sessionEx.getCompletedSetsCount();

      if (completedSets > 0) {
        let totalReps: number = 0;
        let totalWeight: number = 0;
        for (let j: number = 0; j < sessionEx.sets.length; j++) {
          if (sessionEx.sets[j].isCompleted) {
            totalReps += sessionEx.sets[j].reps;
            totalWeight += sessionEx.sets[j].weight;
          }
        }
        exercises.push(new ExerciseModel(
          0, sessionEx.actionName, completedSets,
          Math.floor(totalReps / completedSets), Math.floor(totalWeight / completedSets),
          0, sessionEx.muscleGroup, sessionEx.note, 0
        ));
      }
    }

    record.exercises = exercises;
    record.totalSets = this.session.getTotalCompletedSets();
    record.totalWeight = this.session.getTotalVolume();
    record.caloriesBurned = Math.floor(record.totalWeight * 0.1);
    return record;
  }

  // ==================== è¾…åŠ©æ–¹æ³• ====================

  /**
   * æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ä¸º YYYY-MM-DD HH:mm:ss æ ¼å¼
   */
  formatDateTime(date: Date): string {
    const year: string = date.getFullYear().toString();
    const month: string = (date.getMonth() + 1 < 10 ? '0' : '') + (date.getMonth() + 1).toString();
    const day: string = (date.getDate() < 10 ? '0' : '') + date.getDate().toString();
    const hours: string = (date.getHours() < 10 ? '0' : '') + date.getHours().toString();
    const minutes: string = (date.getMinutes() < 10 ? '0' : '') + date.getMinutes().toString();
    const seconds: string = (date.getSeconds() < 10 ? '0' : '') + date.getSeconds().toString();
    return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
  }

  refreshSession(): void {
    this.session = new TrainingSessionModel(
      this.session.title, this.session.startTime, this.session.pausedTime,
      this.session.exercises, this.session.mood, this.session.notes,
      this.session.isRunning, this.session.planId
    );
  }

  selectMood(mood: string): void {
    this.session.mood = mood;
  }

  showNoteInput(): void {
    this.tempNote = this.session.notes;
    this.showNoteDialog = true;
  }

  saveNote(): void {
    this.session.notes = this.tempNote;
    this.showNoteDialog = false;
    toast('å¿ƒå¾—å·²ä¿å­˜');
  }

  getCurrentSetType(): string {
    if (this.currentEditExerciseIndex >= 0 && this.currentEditSetIndex >= 0) {
      return this.session.exercises[this.currentEditExerciseIndex].sets[this.currentEditSetIndex].setType;
    }
    return SetTypeConst.WORKING;
  }

  // ==================== æ—¶é—´ç¼–è¾‘ç›¸å…³ ====================

  /**
   * æ‰“å¼€æ—¶é—´ç¼–è¾‘å¯¹è¯æ¡†
   */
  openTimeEditDialog(): void {
    const totalSeconds: number = this.session.getDurationInSeconds();
    const hours: number = Math.floor(totalSeconds / 3600);
    const minutes: number = Math.floor((totalSeconds % 3600) / 60);
    const secs: number = totalSeconds % 60;
    this.editHours = hours.toString();
    this.editMinutes = minutes.toString();
    this.editSeconds = secs.toString();
    this.showTimeEditDialog = true;
  }

  /**
   * ä¿å­˜ç¼–è¾‘çš„æ—¶é—´
   */
  saveEditedTime(): void {
    const hours: number = parseInt(this.editHours) || 0;
    const minutes: number = parseInt(this.editMinutes) || 0;
    const seconds: number = parseInt(this.editSeconds) || 0;
    const totalSeconds: number = hours * 3600 + minutes * 60 + seconds;
    const totalMs: number = totalSeconds * 1000;

    // è°ƒæ•´ startTime ä½¿å¾—æ˜¾ç¤ºçš„æ—¶é—´ä¸ºç”¨æˆ·è¾“å…¥çš„å€¼
    this.session.startTime = Date.now() - totalMs - this.session.pausedTime;
    this.showTimeEditDialog = false;
    this.updateTimer();
    toast('æ—¶é—´å·²æ›´æ–°');
  }

  /**
   * é‡ç½®æ—¶é—´ä¸º0
   */
  resetTimer(): void {
    promptAction.showDialog({
      title: 'é‡ç½®æ—¶é—´',
      message: 'ç¡®å®šè¦å°†è®­ç»ƒæ—¶é—´é‡ç½®ä¸º 00:00:00 å—ï¼Ÿ',
      buttons: [{ text: 'å–æ¶ˆ', color: '#666666' }, { text: 'é‡ç½®', color: '#FF0000' }]
    }).then((data: promptAction.ShowDialogSuccessResponse): void => {
      if (data.index === 1) {
        this.session.startTime = Date.now();
        this.session.pausedTime = 0;
        this.pauseStartTime = 0;
        this.updateTimer();
        toast('æ—¶é—´å·²é‡ç½®');
      }
    }).catch((): void => {});
  }

  // ==================== UI æ„å»º ====================

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      Column() {
        this.TopBar()

        if (this.isLoadingRecord) {
          // åŠ è½½è®­ç»ƒè®°å½•ä¸­
          Column({ space: 16 }) {
            LoadingProgress()
              .width(48)
              .height(48)
              .color('#007AFF')
            Text('åŠ è½½è®­ç»ƒè®°å½•ä¸­...')
              .fontSize(14)
              .fontColor('#999999')
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        } else {
          Scroll() {
            Column({ space: 16 }) {
              if (this.session.exercises.length === 0) {
                this.EmptyState()
              } else {
                ForEach(this.session.exercises, (exercise: SessionExerciseModel, index: number) => {
                  SessionExerciseCard({
                    exercise: exercise,
                    exerciseIndex: index,
                    onRemoveExercise: (idx: number): void => { this.removeExercise(idx); },
                    onAddSet: (idx: number): void => { this.addSet(idx); },
                    onToggleSetComplete: (eIdx: number, sIdx: number): void => { this.toggleSetComplete(eIdx, sIdx); },
                    onRemoveSet: (eIdx: number, sIdx: number): void => { this.removeSet(eIdx, sIdx); },
                    onShowSetTypeSelector: (eIdx: number, sIdx: number): void => { this.showSetTypeSelector(eIdx, sIdx); }
                  })
                })
              }

              TrainingFeedbackSection({
                selectedMood: this.session.mood,
                onSelect: (m: string): void => { this.selectMood(m); }
              })

              Column().height(100)
            }
            .width('100%')
            .padding(16)
          }
          .layoutWeight(1)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')

      this.BottomBar()

      if (this.showNoteDialog) {
        this.NoteDialog()
      }

      if (this.showSetTypeMenu) {
        SetTypeSelectDialog({
          currentSetType: this.getCurrentSetType(),
          onSelect: (setType: string): void => { this.changeSetType(setType); },
          onCancel: (): void => {
            this.showSetTypeMenu = false;
            this.currentEditExerciseIndex = -1;
            this.currentEditSetIndex = -1;
          }
        })
      }

      if (this.showTimeEditDialog) {
        this.TimeEditDialog()
      }
    }
    .width('100%')
    .height('100%')
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }

  @Builder
  TopBar() {
    Column({ space: 0 }) {
      Row() {
        Text('Ã—')
          .fontSize(24)
          .fontColor('#666666')
          .fontWeight(FontWeight.Lighter)
          .width(40)
          .height(40)
          .textAlign(TextAlign.Center)
          .onClick((): void => { router.back(); })

        TextInput({ text: this.session.title })
          .layoutWeight(1)
          .fontSize(17)
          .fontWeight(FontWeight.Bold)
          .backgroundColor(Color.Transparent)
          .margin({ left: 8, right: 8 })
          .onChange((value: string): void => { this.session.title = value; })

        Button('å®Œæˆ')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .height(34)
          .padding({ left: 16, right: 16 })
          .backgroundColor('#34C759')
          .borderRadius(17)
          .onClick((): void => { this.finishTraining(); })
      }
      .width('100%')
      .height(56)
      .padding({ left: 12, right: 16 })

      Row() {
        Row({ space: 6 }) {
          // æ—¶é—´æ˜¾ç¤ºï¼Œç‚¹å‡»å¯ç¼–è¾‘
          Text(this.currentTime)
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#007AFF')
            .onClick((): void => { this.openTimeEditDialog(); })

          // æš‚åœ/ç»§ç»­æŒ‰é’®
          Button() {
            Text(this.session.isRunning ? 'â¸' : 'â–¶').fontSize(14).fontColor('#007AFF')
          }
          .width(32).height(32).backgroundColor('#EBF5FF').borderRadius(16)
          .onClick((): void => { this.toggleTimer(); })

          // é‡ç½®æŒ‰é’®
          Button() {
            Text('â†º').fontSize(14).fontColor('#FF6B6B')
          }
          .width(32).height(32).backgroundColor('#FFF0F0').borderRadius(16)
          .onClick((): void => { this.resetTimer(); })
        }

        Row({ space: 16 }) {
          this.StatItem(this.session.getTotalCompletedSets().toString(), 'ç»„')
          this.StatItem(this.session.getCompletedExercisesCount().toString(), 'åŠ¨ä½œ')
          this.StatItem(this.session.getTotalVolume().toString(), 'kg')
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8, bottom: 16 })
      .justifyContent(FlexAlign.SpaceBetween)
    }
    .width('100%')
    .backgroundColor(Color.White)
    .shadow({ radius: 4, color: 'rgba(0, 0, 0, 0.04)', offsetX: 0, offsetY: 2 })
  }

  @Builder
  StatItem(value: string, label: string) {
    Column({ space: 2 }) {
      Text(value).fontSize(18).fontWeight(FontWeight.Bold).fontColor('#1A1A1A')
      Text(label).fontSize(11).fontColor('#999999')
    }.alignItems(HorizontalAlign.Center)
  }

  @Builder
  EmptyState() {
    Column({ space: 20 }) {
      Column() {
        Text('ğŸ‹ï¸').fontSize(64)
      }
      .width(120).height(120).backgroundColor('#F5F7FA').borderRadius(60).justifyContent(FlexAlign.Center)

      Column({ space: 8 }) {
        Text('å‡†å¤‡å¼€å§‹è®­ç»ƒ').fontSize(18).fontWeight(FontWeight.Bold).fontColor('#1A1A1A')
        Text('ç‚¹å‡»ä¸‹æ–¹ã€Œæ·»åŠ åŠ¨ä½œã€å¼€å§‹è®°å½•').fontSize(14).fontColor('#999999')
      }.alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .margin({ top: 60 })
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  BottomBar() {
    Row({ space: 10 }) {
      Button() {
        Row({ space: 6 }) {
          Text('+').fontSize(18).fontWeight(FontWeight.Bold).fontColor(Color.White)
          Text('æ·»åŠ åŠ¨ä½œ').fontSize(14).fontWeight(FontWeight.Medium).fontColor(Color.White)
        }
      }
      .height(48).layoutWeight(1).backgroundColor('#007AFF').borderRadius(12)
      .onClick((): void => { this.addExercise(); })

      Button() {
        Row({ space: 6 }) {
          Text('ğŸ“').fontSize(16)
          Text('å¿ƒå¾—').fontSize(14).fontWeight(FontWeight.Medium).fontColor('#333333')
        }
      }
      .height(48).layoutWeight(0.6).backgroundColor('#F5F5F5').borderRadius(12)
      .onClick((): void => { this.showNoteInput(); })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .backgroundColor(Color.White)
    .shadow({ radius: 8, color: 'rgba(0, 0, 0, 0.08)', offsetX: 0, offsetY: -2 })
  }

  @Builder
  NoteDialog() {
    Column() {
      Column({ space: 0 }) {
        Text('è®­ç»ƒå¿ƒå¾—')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .width('100%')
          .textAlign(TextAlign.Center)
          .padding(16)

        TextArea({ text: this.tempNote })
          .width('100%')
          .height(200)
          .fontSize(14)
          .backgroundColor(Color.White)
          .onChange((value: string): void => { this.tempNote = value; })

        Row({ space: 12 }) {
          Button('å–æ¶ˆ')
            .layoutWeight(1)
            .height(44)
            .backgroundColor('#E0E0E0')
            .fontColor('#333333')
            .onClick((): void => { this.showNoteDialog = false; })

          Button('ä¿å­˜')
            .layoutWeight(1)
            .height(44)
            .backgroundColor('#007AFF')
            .onClick((): void => { this.saveNote(); })
        }
        .width('100%')
        .padding(16)
      }
      .width('90%')
      .backgroundColor(Color.White)
      .borderRadius(12)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('rgba(0, 0, 0, 0.5)')
    .justifyContent(FlexAlign.Center)
    .onClick((): void => { this.showNoteDialog = false; })
  }

  @Builder
  TimeEditDialog() {
    Column() {
      Column({ space: 0 }) {
        Text('ç¼–è¾‘è®­ç»ƒæ—¶é—´')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .width('100%')
          .textAlign(TextAlign.Center)
          .padding(16)

        Row({ space: 8 }) {
          // å°æ—¶è¾“å…¥
          Column({ space: 4 }) {
            TextInput({ text: this.editHours })
              .width(70)
              .height(50)
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .textAlign(TextAlign.Center)
              .type(InputType.Number)
              .backgroundColor('#F5F5F5')
              .borderRadius(8)
              .onChange((value: string): void => {
                this.editHours = value;
              })
            Text('å°æ—¶')
              .fontSize(12)
              .fontColor('#999999')
          }
          .alignItems(HorizontalAlign.Center)

          Text(':')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')

          // åˆ†é’Ÿè¾“å…¥
          Column({ space: 4 }) {
            TextInput({ text: this.editMinutes })
              .width(70)
              .height(50)
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .textAlign(TextAlign.Center)
              .type(InputType.Number)
              .backgroundColor('#F5F5F5')
              .borderRadius(8)
              .onChange((value: string): void => {
                // é™åˆ¶åˆ†é’Ÿåœ¨ 0-59
                const min: number = parseInt(value) || 0;
                if (min > 59) {
                  this.editMinutes = '59';
                } else {
                  this.editMinutes = value;
                }
              })
            Text('åˆ†é’Ÿ')
              .fontSize(12)
              .fontColor('#999999')
          }
          .alignItems(HorizontalAlign.Center)

          Text(':')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')

          // ç§’æ•°è¾“å…¥
          Column({ space: 4 }) {
            TextInput({ text: this.editSeconds })
              .width(70)
              .height(50)
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .textAlign(TextAlign.Center)
              .type(InputType.Number)
              .backgroundColor('#F5F5F5')
              .borderRadius(8)
              .onChange((value: string): void => {
                // é™åˆ¶ç§’æ•°åœ¨ 0-59
                const sec: number = parseInt(value) || 0;
                if (sec > 59) {
                  this.editSeconds = '59';
                } else {
                  this.editSeconds = value;
                }
              })
            Text('ç§’')
              .fontSize(12)
              .fontColor('#999999')
          }
          .alignItems(HorizontalAlign.Center)
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .padding({ top: 8, bottom: 16 })

        Text('ç‚¹å‡»æ•°å­—å¯ä»¥ç›´æ¥è¾“å…¥ä¿®æ”¹')
          .fontSize(12)
          .fontColor('#999999')
          .margin({ bottom: 16 })

        Row({ space: 12 }) {
          Button('å–æ¶ˆ')
            .layoutWeight(1)
            .height(44)
            .backgroundColor('#E0E0E0')
            .fontColor('#333333')
            .onClick((): void => { this.showTimeEditDialog = false; })

          Button('ç¡®å®š')
            .layoutWeight(1)
            .height(44)
            .backgroundColor('#007AFF')
            .onClick((): void => { this.saveEditedTime(); })
        }
        .width('100%')
        .padding(16)
      }
      .width('90%')
      .backgroundColor(Color.White)
      .borderRadius(12)
      .onClick((): void => {
        // é˜»æ­¢ç‚¹å‡»å†…éƒ¨å…³é—­å¯¹è¯æ¡†
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('rgba(0, 0, 0, 0.5)')
    .justifyContent(FlexAlign.Center)
    .onClick((): void => { this.showTimeEditDialog = false; })
  }
}
